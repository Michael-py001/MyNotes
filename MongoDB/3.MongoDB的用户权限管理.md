# 3.MongoDB的用户权限管理

> [User Management Commands — MongoDB Manual](https://www.mongodb.com/docs/manual/reference/command/nav-user-management/)

## 创建用户

> [createUser — MongoDB 手册 --- createUser — MongoDB Manual](https://www.mongodb.com/docs/manual/reference/command/createUser/)
>
> [db.createUser() — MongoDB Manual](https://www.mongodb.com/docs/manual/reference/method/db.createUser/#mongodb-method-db.createUser)

使用 `db.createUser()` 方法创建一个新用户。你需要提供用户名、密码和角色。

```js
db.createUser({
  user: 'myUser',
  pwd: 'myPassword', // or passwordPrompt()
  roles: [{ role: 'readWrite', db: 'myDatabase' }]
})
```

## 查看用户列表

### 使用mongosh help命令

> [mongosh 帮助 — MongoDB Shell --- mongosh Help — MongoDB Shell](https://www.mongodb.com/docs/mongodb-shell/reference/access-mdb-shell-help/)

```
show users
```

![image-20240118182627253](https://s2.loli.net/2024/01/18/VtJ5UGorZApubek.png)

### 使用mongosh method命令

> [db.getUsers() — MongoDB Manual](https://www.mongodb.com/docs/manual/reference/method/db.getUsers/)

```
db.getUsers()
```

![image-20240122170352075](https://s2.loli.net/2024/01/22/xLPpsQSbk7HZ6wl.png)

### 使用常规语法在集合中查询

> [List Users — MongoDB Manual](https://www.mongodb.com/docs/manual/tutorial/list-users/)

```sh
use admin
db.system.users.find()
```

![image-20240122172737355](https://s2.loli.net/2024/01/22/f2igtpT3bD8zkoy.png)

## MongoDB中的角色概念

> [Built-In Roles — MongoDB Manual](https://www.mongodb.com/docs/manual/reference/built-in-roles/#std-label-built-in-roles)

在 MongoDB 中，角色是一种机制，用于控制用户可以对数据库执行哪些操作。每个角色都有一组特定的权限，这些权限定义了角色可以在哪些数据库上执行哪些操作。

MongoDB 提供了一些内置的角色，包括：

- `read`：允许用户在指定数据库上执行读取操作。
- `readWrite`：允许用户在指定数据库上执行读取和写入操作。
- `dbAdmin`：允许用户在指定数据库上执行管理任务，如创建和删除索引、查看统计信息等。
- `userAdmin`：允许用户在指定数据库上管理用户和角色。
- `clusterAdmin`：提供了最高级别的集群管理权限，包括添加和删除用户、分片和复制等。

你也可以创建自定义的角色，并为它们分配特定的权限。

在 MongoDB 中，用户可以拥有一个或多个角色。当一个用户尝试执行一个操作时，MongoDB 会检查用户的所有角色，以确定用户是否有权限执行这个操作。

## 为用户分配角色？

在 MongoDB 中，你可以使用 `db.grantRolesToUser()` 方法为用户分配角色。以下是一个步骤示例：

1. 首先，启动 MongoDB 服务，并使用 `mongodsh` 命令连接到 MongoDB shell。

```bash
mongodsh
```

2. 选择你想要分配角色的数据库。

```javascript
use myDatabase
```

3. 使用 `db.grantRolesToUser()` 方法为用户分配角色。

```javascript
db.grantRolesToUser('myUser', [{ role: 'readWrite', db: 'myDatabase' }])
```

在这个例子中，我们为 `myUser` 用户分配了 `myDatabase` 数据库的 `readWrite` 角色。

### 为同一个用户在多个数据库分配相同的角色

如果你想为一个用户在多个数据库中分配相同的角色，你需要为每个数据库创建一个角色对象。例如：

```js
db.updateUser('myUser', {
  roles: [
    { role: 'readWrite', db: 'myDatabase1' },
    { role: 'readWrite', db: 'myDatabase2' },
    { role: 'readWrite', db: 'myDatabase3' }
  ]
})
```



## 给用户追加或者修改角色、db

使用 `db.updateUser()` 方法修改用户的角色和数据库。

```js
db.updateUser('myUser', {
  roles: [
    { role: 'readWrite', db: 'myDatabase' },
    { role: 'read', db: 'otherDatabase' }
  ]
})
```

### updateUser和grantRolesToUser的区别

`db.updateUser()` 和 `db.grantRolesToUser()` 都可以用来修改 MongoDB 用户的角色，但它们的用途和行为有一些区别：

- `db.updateUser()`：这个方法用来更新用户的信息，包括密码和角色。当你使用这个方法更新角色时，它会替换用户的当前角色。也就是说，如果用户之前有其他角色，这些角色会被新的角色列表覆盖。
- `db.grantRolesToUser()`：这个方法用来给用户添加角色。当你使用这个方法时，它会保留用户的当前角色，并添加新的角色。也就是说，用户会同时拥有旧的角色和新的角色。

因此，如果你想要完全替换用户的角色，你应该使用 `db.updateUser()`。如果你只想添加一些新的角色，而不影响用户的当前角色，你应该使用 `db.grantRolesToUser()`。