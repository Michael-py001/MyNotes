# 20220511-Vue3移动端适配：手动与使用插件的两种方法

## 使用插件: postcss-pxtorem 配合 amfe-flexible

### postcss-pxtorem

> [postcss-pxtorem - npm (npmjs.com)](https://www.npmjs.com/package/postcss-pxtorem)
>
> 可以把px单位转换成rem单位，

安装

```bash
npm install postcss postcss-pxtorem --save-dev
```

### 插件的主要参数

1. `rootValue`: （Number | Function）主要根据根元素字体大小设置或者根据`input`参数返回根元素字体大小(估计是用在函数时)

2. `propList` (Array)  允许从px更改为rem的属性

   - 使用通配符`*`启用所有属性。例：`['*']`
   - `*`在单词的开头或结尾使用。（`['*position*']`将匹配`background-position-y`）
   - 使用`!`不匹配的属性。例：`['*', '!letter-spacing']`
   - 将“ not”前缀与其他前缀组合。例：`['*', '!font*']`

3. `selectorBlackList` （Array）要忽略的选择器，保留为px。

   - 如果value是字符串，它将检查选择器是否包含字符串。
     - `['body']` 将匹配 `.body-class`
   - 如果value是regexp，它将检查选择器是否匹配regexp。
     - `[/^body$/]`将匹配`body`但不匹配`.body`

4. `mediaQuery` （Boolean）允许在媒体查询中转换px。

5. 忽略单个属性的最简单方法是在像素单位声明中使用大写字母，将px写为Px。

   　　比如：

   ```css
   .ignore {
       border: 1Px solid; // ignored
       border-width: 2PX; // ignored
   }
   ```

Vue3.x & Vite 项目里面打开`vite.config.js`

```js
//vite.config.js
import { fileURLToPath, URL } from 'url'
const pxtorem = require('postcss-pxtorem');
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
// https://vitejs.dev/config/
export default defineConfig({
  css:{
    postcss:{
      plugins:[
        pxtorem({
          rootValue: 37.5, //根据两倍屏时html的font-size的值设置
          propList: ['*']
        })
      ]
    }
  },
  plugins: [vue()],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    }
  }
})
```

### amfe-flexible

安装

```js
npm i -S amfe-flexible
```

使用

在`main.js`引入即可

```js
//main.js
import 'amfe-flexible'
```

根据以上的设置，已经实现了px自动转换成rem单位，在chrome控制台选择ipnone SE设备模拟时，网页html的`font-size`设置成了`37.5px`。

现在的问题是，`postcss-pxtorem`的`rootValue`要怎么设置？设置多少才是正确的？

我总结出的答案是，根据设计稿宽为750px，这个是750代表的是设备的物理像素有750个，但是两倍屏里，比如iphone 6,屏幕的实际宽度像素有750个，但是他是两倍屏，比如2\*2(设备独立像素)实际显示等价于4\*4个物理像素显示。

iphone6的屏幕DPR是2，所以它的设备独立像素等于 750 / 2 = 375。也就是我们设置375px就可以铺满这个屏幕宽度。

因为我们使用的是rem适配，所以需要设置根节点的`font-size`，为了方便，一般取设计稿宽度的十分之一，也就是750 / 10 = 75，还要除以DPR才能得到实际的CSS像素，故`75 / 2 = 37.5`此时`1rem = 37.5px`。

`rootValue`就是取这个`37.5px`

![image-20220509155103761](https://s2.loli.net/2022/05/11/7LGrVonfqd5MKQ6.png)

## 手动计算

`unitRemPro`只需传入`designSize`设计稿尺寸 `baseSize`基准值(这里的基准值不用考虑DPR，里面会自动计算，只需根据设计稿尺寸，一般取设计稿的十分之一)即可自动计算

```js
(function(doc,win){
  const docEl = doc.documentElement
  const dpr = win.devicePixelRatio
  const designSize = 750 //设计稿尺寸
  const baseSize = 75 // 1rem 等于多少px的基准值
  function adjustBody() {
    if(doc.body) {
      doc.body.style.fontSize = 12 * dpr + 'px'
    }
    else {
      docEl.addEventListener('DOMContentLoaded',adjustBody)
    }
  }
  adjustBody()

  function unitRemPro(_designSize,_baseSize) {
    const dpr = win.devicePixelRatio
    let baseSizeScale = (_baseSize || _designSize / 10) / dpr //加入dpr计算缩放 没有传入_baseSize则自动换算成_designSize / 10
    let scale = docEl.clientWidth / (_designSize / dpr) //缩放倍数 页面宽度 : 设计稿转换成设备独立像素 的比例 
    /***
     * DPR是每个设备都不一样的，与PPI像素密度有关
     * _designSize / dpr = 物理像素 / DPR 
     * 因为 DPR = 物理像素 / 设备独立像素
     * 所以 _designSize / dpr = 物理像素 / (物理像素 / 设备独立像素) = 物理像素 * (设备独立像素 / 物理像素) = 设备独立像素
     */
    console.log("dpr:",dpr,"baseSize:",baseSizeScale,"scale:",scale)
    docEl.style.fontSize = baseSizeScale * Math.min(scale,2) + 'px'
  }

  unitRemPro(designSize,baseSize)
  window.addEventListener('resize',()=>unitRemPro(designSize,baseSize))
})(document,window);

```

