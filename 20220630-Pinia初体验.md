# 20220630-Piniaåˆä½“éªŒ

> ç›¸å…³æ–‡ç« ï¼š
>
> [Piniaå¦‚ä½•modulesæ¨¡å—åˆ’åˆ†ã€æ¨¡å—ä¹‹å‰å¦‚ä½•é€šä¿¡ï¼Ÿ - å”¯å“ç§€å‰ç«¯åšå®¢ (weipxiu.com)](https://www.weipxiu.com/8341.html)
>
> [Vue3ä¸­Piniaå®ç°æ•°æ®çŠ¶æ€ç®¡ç†stateã€gettersã€actions - å”¯å“ç§€å‰ç«¯åšå®¢ (weipxiu.com)](https://www.weipxiu.com/8334.html)
>
> [Piniaå¦‚ä½•è®©æ•°æ®æŒä¹…åŒ–å­˜å‚¨ï¼Ÿ - å”¯å“ç§€å‰ç«¯åšå®¢ (weipxiu.com)](https://www.weipxiu.com/8343.html)
>
> [Vue3ä¸­defineExposeæš´éœ²å‡ºæ¥çš„æ•°æ®å¦‚ä½•å“åº”å¼ - å”¯å“ç§€å‰ç«¯åšå®¢ (weipxiu.com)](https://www.weipxiu.com/8581.html)
>
> [How to Migrate from Vuex to Pinia - Vue School Blog](https://vueschool.io/articles/vuejs-tutorials/how-to-migrate-from-vuex-to-pinia/?utm_source=drip&utm_medium=email&utm_campaign=How to Migrate from Vuex to Pinia ğŸ)

å®˜æ–¹æ–‡æ¡£

> [ä»‹ç» | Pinia ä¸­æ–‡æ–‡æ¡£ (web3doc.top)](https://pinia.web3doc.top/introduction.html#åŸºæœ¬ç¤ºä¾‹)
>
> [Introduction | Pinia (vuejs.org)](https://pinia.vuejs.org/introduction.html#basic-example)

## uniappä½¿ç”¨pinia

> [çŠ¶æ€ç®¡ç† Pinia | uni-appå®˜ç½‘ (dcloud.io)](https://uniapp.dcloud.io/tutorial/vue3-pinia.html)



## æŒä¹…åŒ– pinia-plugin-persistæ’ä»¶

1. ### å®‰è£…æ’ä»¶

```
npm i pinia-plugin-persist --save
```

2. ### store/index.js

```js
import { createPinia } from 'pinia'
import piniaPluginPersist from 'pinia-plugin-persist'

const store = createPinia()
store.use(piniaPluginPersist)

export default store
```

3. ### store/user.js

```js
import { createPinia } from 'pinia'
import piniaPluginPersist from 'pinia-plugin-persist'

const store = createPinia()
store.use(piniaPluginPersist)

export default store
```

4. ### è‡ªå®šä¹‰ key

â€‹	æ•°æ®é»˜è®¤å­˜åœ¨sessionStorageé‡Œï¼Œå¹¶ä¸”ä¼šä»¥storeçš„idä½œä¸º keyã€‚

```js
persist: {
  enabled: true,
  strategies: [
    {
      key: 'my_user', // é»˜è®¤keyæ˜¯ä¸Šé¢storeçš„idï¼Œå¯è‡ªå®šä¹‰key
      storage: localStorage, // é»˜è®¤æ˜¯sessionStorageä¼šè¯å­˜å‚¨ï¼Œå¯ä»¥è®¾ç½®ä¸ºlocalStorageæœ¬åœ°é•¿å­˜å‚¨
    }
  ]
}
```

5. #### æŒä¹…åŒ–å±€éƒ¨ state

é»˜è®¤æ‰€æœ‰ state éƒ½ä¼šè¿›è¡Œç¼“å­˜ï¼Œä½ èƒ½å¤Ÿé€šè¿‡ paths æŒ‡å®šè¦é•¿ä¹…åŒ–çš„å­—æ®µï¼Œå…¶ä½™çš„åˆ™ä¸ä¼šè¿›è¡Œé•¿ä¹…åŒ–ã€‚

```js
state: () => {
  return {
    name: 'å¼ ä¸‰',
    age: 18,
    gender: 'ç”·'
  }  
},

persist: {
  enabled: true,
  strategies: [
    {
      storage: localStorage,
      paths: ['name', 'age']
    }
  ]
}
```

## storeToRefs

æœ¬èº«piniaå¯ä»¥ç›´æ¥ä¿®æ”¹stateæ•°æ®ï¼Œæ— éœ€åƒvuexä¸€æ ·é€šè¿‡`mutations`æ‰å¯ä»¥ä¿®æ”¹ï¼Œä½†æ˜¯ä¸Šé¢å†™çš„let { name } = store;è¿™ç§è§£æ„æ˜¯ä¸å¯ä»¥çš„ï¼Œæ‰€ä»¥è¦é€šè¿‡storeToRefsæ–¹æ³•ç»“æ„

```html
<script setup>
import { storeToRefs } from 'pinia'
import { useStore } from '../store'
const store = useStore();
let { name }  = storeToRefs(store);
const btn = ()=>{
    name.value = '123';
}
</script>
```

```js
import { storeToRefs } from 'pinia'

export default defineComponent({
  setup() {
    const store = useStore()
    // `name` and `doubleCount` are reactive refs
    // This will also create refs for properties added by plugins
    // but skip any action or non reactive (non ref/reactive) property
    const { name, doubleCount } = storeToRefs(store)
    // the increment action can be just extracted
    const { increment } = store

    return {
      name,
      doubleCount,
      increment,
    }
  },
})
```

å¦‚æœstoreä¸­è¿˜æœ‰actionsé‡Œé¢çš„æ–¹æ³•ï¼Œé‚£ä¹ˆç”¨`storeToRefs`åè¿”å›çš„åªæœ‰stateé‡Œçš„æ•°æ®ï¼Œactionsé‡Œçš„æ–¹æ³•ä¼šè¢«è¿‡æ»¤

### watchç›‘å¬è§£æ„çš„å€¼

```js
watch(()=>doubleCount,()=>{}) //æœ‰æ•ˆ
watch(doubleCount,()=>{}) //æ— æ•ˆ
```

å¦‚æœè¿™ä¸ªå€¼æ˜¯ä¸ªå¯¹è±¡ï¼Œéœ€è¦è¦`deep:true`

```js
watch(()=>doubleCount,()=>{},{deep:true})
```



## stateæ•°æ®éœ€è¦æ‰¹é‡æ›´æ–°

```js
// store/index.js
import { defineStore } from 'pinia'

export const useStore = defineStore('storeId', {
  state: () => {
    return {
      counter: 0,
      name: 'Eduardo',
      arr:['a','b','c']
    }
  },
  getters:{},
  actions:{}
})
```

```js
<template>
  <div>
    <h1>Aç»„ä»¶</h1>
    {{ name }} {{ counter }} {{ arr }}

    <button @click='btn'>æŒ‰é’®</button>
  </div>
</template>
<script setup>
  import {
    storeToRefs
  }
  from 'pinia'
  import {
    useStore
  }
  from '../store'
  const store = useStore();
  let {
    name, counter, arr
  } = storeToRefs(store);
  const btn = () => {
    //$patchæ‰¹é‡æ›´æ–°æœ‰ä¸¤ç§å†™æ³•
    //ç¬¬ä¸€ç§
    /*
      $patchä¹Ÿæœ‰ä¸¤ç§çš„è°ƒç”¨æ–¹å¼
      ç¬¬ä¸€ç§å†™æ³•çš„åœ¨ä¿®æ”¹æ•°ç»„æ—¶ï¼Œå‡å¦‚æˆ‘åªæƒ³è¦æŠŠ ipList çš„ä¸­ç¬¬2é¡¹æ”¹æˆâ€˜192.168.10.222â€™ï¼Œ
      ä½†æ˜¯ä¹Ÿéœ€è¦ä¼ å…¥æ•´ä¸ªåŒ…æ‹¬æ‰€æœ‰å…ƒç´ çš„æ•°ç»„ï¼Œè¿™æ— ç–‘å¢åŠ äº†ä¹¦å†™æˆæœ¬å’Œé£é™©ï¼Œæ˜¾ç„¶æ˜¯ä¸åˆç†çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½æ¨èä½¿ç”¨ç¬¬äºŒç§ä¼ å…¥ä¸€ä¸ªå‡½æ•°çš„å†™æ³•
      */
    store.$patch({
      counter: 10001,
      appList: [1, 2, 3]
    })

    // ç¬¬äºŒç§
    store.$patch(state => {
      state.counter = 10001;
      state.ipList[0] = 100;
    })
  }
</script>
```

## æ›¿æ¢`state`

æ‚¨å¯ä»¥é€šè¿‡å°†å…¶ `$state` å±æ€§è®¾ç½®ä¸ºæ–°å¯¹è±¡æ¥æ›¿æ¢ Store çš„æ•´ä¸ªçŠ¶æ€ï¼š

```
store.$state = { counter: 666, name: 'Paimon' }
```

æ‚¨è¿˜å¯ä»¥é€šè¿‡æ›´æ”¹ `pinia` å®ä¾‹çš„ `state` æ¥æ›¿æ¢åº”ç”¨ç¨‹åºçš„æ•´ä¸ªçŠ¶æ€ã€‚ è¿™åœ¨ [SSR for hydration](https://pinia.web3doc.top/ssr/#state-hydration) æœŸé—´ä½¿ç”¨ã€‚

```js
pinia.state.value = {}
```

## é‡ç½®çŠ¶æ€

æ‚¨å¯ä»¥é€šè¿‡è°ƒç”¨ store ä¸Šçš„ $reset() æ–¹æ³•å°†çŠ¶æ€ é‡ç½® åˆ°å…¶åˆå§‹å€¼ï¼š

```js

const store = useStore()

store.$reset()
```

## stateåœ¨Options APIå’ŒComposition APIçš„ä½¿ç”¨

```js
// Example File Path:
// ./src/stores/counterStore.js

import { defineStore } from 'pinia'

const useCounterStore = defineStore('counterStore', {
  state: () => ({
    counter: 0,
  }),
})
```

If you are not using the Composition API, and you are using `computed`, `methods`, ..., you can use the `mapState()` helper to map state properties as readonly computed properties:

```js
import { mapState } from 'pinia'
import { useCounterStore } from '../stores/counterStore'

export default {
  computed: {
    // gives access to this.counter inside the component
    // same as reading from store.counter
    ...mapState(useCounterStore, ['counter'])
    // same as above but registers it as this.myOwnName
    ...mapState(useCounterStore, {
      myOwnName: 'counter',
      // you can also write a function that gets access to the store
      double: store => store.counter * 2,
      // it can have access to `this` but it won't be typed correctly...
      magicValue(store) {
        return store.someGetter + this.counter + this.double
      },
    }),
  },
}
```

