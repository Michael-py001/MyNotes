# Cesium 流动线（PolylineTrail）说明与示意

本文基于 mapUtil.js 中 createFlowLine 函数，对“流动线/流光线”的实现方式、关键代码与使用方法进行整理，并提供一张 SVG 示意图便于讲解。

![image-20251218114229796](https://s2.loli.net/2025/12/18/LV7vqDpb8PeAG9o.png)

---

## 1. 功能概述

- 根据传入的 line 配置对象创建并返回一个 Cesium.Entity：
  - polyline：带“流动”纹理效果的折线
  - label：可选文本标签
- 流动效果由 PolylineTrailMaterialProperty 实现，纹理沿线条方向滚动，形成“流光”视觉。

---

## 2. 关键实现代码

createFlowLine 的核心在于为 polyline 指定“时间驱动的流动材质”：

```js
material: new Cesium.PolylineTrailMaterialProperty({
  color: Cesium.Color.fromCssColorString(
    line.imageUrl === null ? defColor : line.imageUrl,
  ),
  trailImage: flowShape, // 纹理图片，控制光带形态/渐变
  duration: lineduration, // 动画周期（ms），越小“流动”越快
});
```

- trailImage：流动纹理（如渐变条、箭头），决定流光造型。
- duration：纹理沿线滚动一圈的时间（毫秒）。
- color：基础着色，与纹理叠加影响最终颜色。

没有该材质时，折线只是静态线条；通过时间 uniform 移动纹理坐标，产生沿线滚动的动画效果。

---

## 3. 主要参数与默认值（代码推断）

- points：经度、纬度、高度序列 [lon, lat, height, ...]，用于 fromDegreesArrayHeights。
- lineWidth：线宽（像素）。
- flowSpeed：流动速度（对应 duration，毫秒），数值越小越快；默认 10000。
- flowShape：纹理图片，默认 faderRedPng。
- imageUrl：被当作 CSS 颜色字符串使用（命名可能误导）；为 null 则使用 defColor。
- id：实体 id（可选）。
- description：用于 label 的文本；空字符串则不显示。
- ...line：其余字段会被展开到 Entity 上，可能覆盖内置 polyline/label 配置（见注意事项）。

---

## 4. 实体结构要点

- polyline.positions：

  ```js
  Cesium.Cartesian3.fromDegreesArrayHeights(line.points);
  ```

  注意 points 必须是“经度、纬度、高度”连续序列，长度为 3 的倍数。

- label：
  - text：description 为空字符串时不显示
  - scale：0.4（较小，避免遮挡）
  - pixelOffset：(0, 20)（上移 20 像素）

---

## 5. 使用方式

仅创建并返回实体，不会自动加到场景：

```js
const entity = createFlowLine({
  points: [116.39, 39.9, 1000, 121.47, 31.23, 1200],
  lineWidth: 4,
  flowSpeed: 4000, // 越小越快
  flowShape: faderRedPng, // 流动纹理
  imageUrl: '#00E5FF', // CSS 颜色字符串
  description: '北京 → 上海',
});

viewer.entities.add(entity);
```

---

## 6. 注意事项与建议

- imageUrl 命名误导：实际上是 CSS 颜色字符串；若传 URL 可能报错。
- null 与 undefined：代码只对 null 做兜底；imageUrl 若为 undefined，fromCssColorString 可能抛错。建议统一传 null 或合法 CSS 颜色。
- ...line 覆盖：...line 放在最后，调用方若在 line 中提供同名 polyline/label 配置，会覆盖函数内置材质/标签设置，需谨慎。
- 性能：大量带动画材质的 polyline 同时存在会增加渲染压力，需控制数量或纹理尺寸。

---

## 7. SVG 讲解图

上方插图 flowline-diagram.png 展示了：

- 纹理沿折线滚动的方向与形态
- 三个关键入参：trailImage（纹理）、color（基色）、duration（速度/周期）
- 通过渐变与发光效果模拟“流光”视觉

## 8. 源码

![image-20251218135614448](https://s2.loli.net/2025/12/18/P1YxHTrLtqpOovm.png)

![image-20251218140155486](https://s2.loli.net/2025/12/18/RXcEqsLriOTWFe8.png)

```js
function createFlowLine(line) {
  let entity;
  if (line === undefined) {
    return undefined;
  }
  let lineduration = line.flowSpeed;
  if (lineduration === undefined) {
    lineduration = 10000; // 使用默认流转速度
  }
  let flowShape = line.flowShape;
  if (flowShape === undefined) {
    flowShape = faderRedPng;
  }
  if (line.id === undefined || line.id === null) {
    entity = new Cesium.Entity({
      polyline: {
        positions: Cesium.Cartesian3.fromDegreesArrayHeights(line.points),
        width: line.lineWidth,
        material: new Cesium.PolylineTrailMaterialProperty({
          color: Cesium.Color.fromCssColorString(line.imageUrl === null ? defColor : line.imageUrl),
          trailImage: flowShape,
          duration: lineduration,
        }),
      },
      label: {
        text: line.description === '' ? '' : line.description,
        scale: 0.4,
        pixelOffset: new Cesium.Cartesian2(0, 20),
      },
      ...line,
    });
  } else {
    entity = new Cesium.Entity({
      id: line.id,
      polyline: {
        positions: Cesium.Cartesian3.fromDegreesArrayHeights(line.points),
        width: line.lineWidth,
        material: new Cesium.PolylineTrailMaterialProperty({
          color: Cesium.Color.fromCssColorString(line.imageUrl === null ? defColor : line.imageUrl),
          trailImage: flowShape,
          duration: lineduration,
        }),
      },
      label: {
        text: line.description === '' ? '' : line.description,
        scale: 0.4,
        pixelOffset: new Cesium.Cartesian2(0, 20),
      },
      ...line,
    });
  }
  return entity;
}
```

## 9.效果图

![1](https://s2.loli.net/2025/12/18/v76AkWIR2dEjbDy.gif)