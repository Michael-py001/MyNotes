æ¥å£è¿”å›çš„æ•°æ®å¤§æ¦‚æ˜¯è¿™æ ·ï¼š

```json
{
    "gisCluster": 463,
    "entityId": 12344,
    "minScaling": 10,
    "maxScaling": 17,
    "gisType": 2,
    "radius": null,
    "otherType": 0,
    "topicName": "10256/10220/10315/12310/12344",
    "projectId": 10315,
    "description": null,
    "gisRule": null,
    "points": [
        {
            "longitude": 111.66351031,
            "latitude": 20.97079161,
            "altitude": 1,
            "info": null
        },
        {
            "longitude": 111.6635292,
            "latitude": 20.97507252,
            "altitude": 1,
            "info": null
        }
    ],
    "style": "{\"flowStyle\":\"start\",\"lineWidth\":3,\"lineStyle\":\"solid\",\"pluginData\":[],\"imageUrl\":\"#ff1e02\",\"imageKey\":\"\"}",
    "createBy": "admin",
    "createTime": 1756715643378,
    "updateBy": null,
    "updateTime": null
}
```

å…¶ä¸­gisType=1æ˜¯é£ç”µåœºç±»å‹ï¼Œæ¸²æŸ“ä¸€ä¸ªiconï¼ŒgisType=2æ˜¯çº¿ç±»å‹ï¼Œæä¾›pointsä¸¤ä¸ªåæ ‡è¿æ¥æˆä¸€æ¡çº¿

è¿™æ˜¯ä¸€ä¸ª **OpenLayers é‡Œæ¯”è¾ƒç»å…¸ã€ä½†éœ€è¦â€œç»„åˆæ‹³â€çš„æ•ˆæœ** ğŸ‘
ä½ çš„éœ€æ±‚å¯ä»¥æ‹†è§£ä¸ºä¸€å¥è¯ï¼š

> **gisType=2 çš„æµ·ç¼†çº¿ï¼Œæ²¿ç€ LineString åšâ€œæµåŠ¨åŠ¨ç”»â€ï¼Œæ–¹å‘æŒ‡å‘ gisType=1 çš„é£ç”µåœºï¼Œä¸”æ— é™å¾ªç¯ã€‚**

ä¸‹é¢æˆ‘ä» **å¯è½åœ°ã€å¯ç»´æŠ¤ã€æ€§èƒ½å¯æ§** çš„è§’åº¦ï¼Œç»™ä½  **3 å¥—æ–¹æ¡ˆï¼ˆç”±æ¨èåˆ°ä¸æ¨èï¼‰**ï¼Œå¹¶ç»“åˆä½ è¿™ä¸ªæ•°æ®ç»“æ„è¯´æ˜æ€ä¹ˆåšã€‚

------

## ä¸€ã€æœ€æ¨èæ–¹æ¡ˆï¼šCanvas åŠ¨æ€ç»˜åˆ¶ï¼ˆpostrender / render äº‹ä»¶ï¼‰

è¿™æ˜¯ **OpenLayers å®˜æ–¹æ¨èçš„çº¿æµåŠ¨æ•ˆæœåšæ³•**ï¼Œä¹Ÿæ˜¯æœ€å¸¸è§ã€æœ€ç¨³çš„æ–¹æ¡ˆã€‚

### æ ¸å¿ƒæ€è·¯

1. **åº•å±‚**ï¼šæ™®é€š `VectorLayer` ç”»ä¸€æ¡â€œé™æ€ç”µç¼†çº¿â€
2. **ä¸Šå±‚**ï¼šåœ¨ `postrender`ï¼ˆæˆ– `render`ï¼‰äº‹ä»¶ä¸­
3. **æ²¿ LineString è®¡ç®—ä¸€ä¸ªâ€œæµåŠ¨ç‚¹ / æµåŠ¨è™šçº¿â€**
4. æ¯ä¸€å¸§æ”¹å˜ offset â†’ çœ‹èµ·æ¥å°±åœ¨â€œå¾€é£ç”µåœºæµåŠ¨â€

------

### æ•ˆæœå½¢å¼ï¼ˆä½ å¯ä»¥é€‰ï¼‰

- ğŸ”¹ æµåŠ¨å°ç‚¹ï¼ˆæœ€åƒâ€œç”µæµâ€ï¼‰
- ğŸ”¹ æµåŠ¨è™šçº¿ï¼ˆdashOffsetï¼‰
- ğŸ”¹ å¸¦æ¸å˜çš„å…‰å¸¦ï¼ˆç¨å¤æ‚ï¼Œä½†æ•ˆæœæœ€å¥½ï¼‰

------

## äºŒã€å®ç°æ–¹æ¡ˆ 1ï¼š**æµåŠ¨è™šçº¿ï¼ˆæœ€ç®€å•ï¼Œå¼ºçƒˆæ¨èå…ˆåšè¿™ä¸ªï¼‰**

### 1ï¸âƒ£ çº¿çš„åŸºç¡€æ ·å¼

```js
const baseLineStyle = new ol.style.Style({
  stroke: new ol.style.Stroke({
    color: '#0aaeff',
    width: 3
  })
});
```

------

### 2ï¸âƒ£ åŠ¨æ€æµåŠ¨æ ·å¼ï¼ˆé‡ç‚¹ï¼‰

```js
let dashOffset = 0;

const flowLineStyle = new ol.style.Style({
  stroke: new ol.style.Stroke({
    color: '#00ffff',
    width: 3,
    lineDash: [10, 20],
    lineDashOffset: dashOffset
  })
});
```

------

### 3ï¸âƒ£ åœ¨ postrender ä¸­åˆ·æ–° offset

```js
vectorLayer.on('postrender', function (event) {
  const frameState = event.frameState;
  dashOffset = -(frameState.time / 50); // æ§åˆ¶é€Ÿåº¦
  vectorLayer.changed(); // è§¦å‘é‡ç»˜
});
```

ğŸ“Œ **æ–¹å‘æ§åˆ¶é‡ç‚¹ï¼š**

- **points é¡ºåºå¿…é¡»æ˜¯ï¼šæµ·ç¼†èµ·ç‚¹ â†’ é£ç”µåœº**
- å¦‚æœä½ æ¥å£é‡Œé¡ºåºä¸å›ºå®šï¼Œéœ€è¦åˆ¤æ–­å¹¶åè½¬

```js
points.reverse();
```

------

### 4ï¸âƒ£ Feature è®¾ç½® styleFunction

```js
feature.setStyle(() => {
  return [baseLineStyle, flowLineStyle];
});
```

âœ… **ä¼˜ç‚¹**

- å®ç°ç®€å•
- æ€§èƒ½æœ€å¥½
- å¤šæ¡çº¿ä¹Ÿæ‰›å¾—ä½

âŒ **ç¼ºç‚¹**

- æµåŠ¨æ˜¯â€œè™šçº¿â€ï¼Œä¸æ˜¯å®ä½“å…‰ç‚¹

------

## ä¸‰ã€å®ç°æ–¹æ¡ˆ 2ï¼š**æµåŠ¨å…‰ç‚¹ï¼ˆæ›´åƒâ€œç”µæµâ€ï¼‰**

è¿™æ˜¯ **è§†è§‰æ•ˆæœæ›´å¥½çš„ç‰ˆæœ¬**ï¼Œä½†ç¨å¾®å¤æ‚ä¸€ç‚¹ã€‚

------

### æ ¸å¿ƒæ€è·¯

- æŠŠ LineString **ç­‰åˆ†æˆå¾ˆå¤šæ®µ**
- æ ¹æ® `time` ç®—å‡ºå½“å‰ç‚¹åœ¨ç¬¬å‡ æ®µ
- åœ¨è¿™ä¸ªä½ç½®ç”»ä¸€ä¸ª `Circle`

------

### å…³é”®ä»£ç ç¤ºæ„

```js
vectorLayer.on('postrender', function (event) {
  const ctx = event.context;
  const frameState = event.frameState;

  vectorSource.forEachFeature(feature => {
    if (feature.get('gisType') !== 2) return;

    const geometry = feature.getGeometry();
    const length = geometry.getLength();

    const speed = 100; // è¶Šå°è¶Šå¿«
    const offset = (frameState.time / speed) % length;

    const coord = geometry.getCoordinateAt(offset / length);
    const pixel = map.getPixelFromCoordinate(coord);

    ctx.beginPath();
    ctx.arc(pixel[0], pixel[1], 4, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(0,255,255,0.8)';
    ctx.fill();
  });

  map.render();
});
```

------

### æ•ˆæœç‰¹ç‚¹

- ä¸€ä¸ªæˆ–å¤šä¸ªå…‰ç‚¹
- å¯åšå°¾è¿¹ï¼ˆæ¸éšï¼‰
- éå¸¸åƒâ€œç”µç¼†ç”µæµâ€

âœ… **ä¼˜ç‚¹**

- è§†è§‰æ•ˆæœå¥½
- å¯ä»¥åšæ–¹å‘ã€åŠ é€Ÿåº¦ã€åˆ†æ®µ

âŒ **ç¼ºç‚¹**

- Canvas æ“ä½œè¾ƒå¤š
- å¤šçº¿æ—¶æ³¨æ„æ€§èƒ½

------

## å››ã€å®ç°æ–¹æ¡ˆ 3ï¼šWebGL Layerï¼ˆé«˜ç«¯ï¼Œä½†ä¸å¿…è¦ï¼‰

OpenLayers çš„ `WebGLVectorLayer`ï¼š

- ç”¨ fragment shader åšæµåŠ¨çº¹ç†
- ç±»ä¼¼ Mapbox çš„ animated line

âŒ **ä¸å»ºè®®ç°åœ¨ä¸Š**

- æˆæœ¬é«˜
- è°ƒè¯•å¤æ‚
- ç»´æŠ¤éš¾

åªæœ‰åœ¨ **ä¸Šç™¾æ¡ç”µç¼† + é«˜å¸§ç‡** æ‰å€¼å¾—ã€‚

------

## äº”ã€ç»“åˆä½ æ•°æ®ç»“æ„çš„å®Œæ•´è®¾è®¡å»ºè®®

### 1ï¸âƒ£ æ•°æ®å¤„ç†

```js
if (item.gisType === 2) {
  const coords = item.points.map(p =>
    ol.proj.fromLonLat([p.longitude, p.latitude])
  );

  const feature = new ol.Feature({
    geometry: new ol.geom.LineString(coords),
    gisType: 2,
    targetId: item.entityId
  });
}
```

------

### 2ï¸âƒ£ é£ç”µåœºå›¾æ ‡ï¼ˆgisType = 1ï¼‰

```js
new ol.style.Style({
  image: new ol.style.Icon({
    src: '/wind.png',
    scale: 0.8,
    anchor: [0.5, 1]
  })
});
```

------

### 3ï¸âƒ£ æ–¹å‘é€»è¾‘ï¼ˆéå¸¸é‡è¦ï¼‰

ä½ å¯ä»¥è¿™æ ·åˆ¤æ–­çº¿æ˜¯ä¸æ˜¯æŒ‡å‘é£ç”µåœºï¼š

```js
const start = coords[0];
const end = coords[coords.length - 1];

if (distance(end, windCoord) > distance(start, windCoord)) {
  coords.reverse();
}
```

------

## å…­ã€å»ºè®®

| ç›®æ ‡     | æ¨è                |
| -------- | ------------------- |
| å¿«é€Ÿä¸Šçº¿ | âœ… **è™šçº¿æµåŠ¨æ–¹æ¡ˆ**  |
| å¥½çœ‹     | âœ… **å…‰ç‚¹æµåŠ¨æ–¹æ¡ˆ**  |
| è§„æ¨¡å¤§   | âŒ WebGLï¼ˆæš‚ä¸éœ€è¦ï¼‰ |

## æ¡ˆä¾‹

(cesiumä¸­å®ç°çš„æ•ˆæœï¼Œè¿ç§»åˆ°openlayer)

![37ea9998-cae7-45e0-9926-c83b9edde08b](https://s2.loli.net/2025/12/18/862VAktIayuFmhZ.png)

è¿™ä¸ªæˆªå›¾**å·²ç»æŠŠå®ç°è·¯çº¿â€œé™å®šâ€å¾—å¾ˆæ¸…æ¥šäº†**ï¼Œæˆ‘å¯ä»¥éå¸¸ç¡®å®šåœ°å‘Šè¯‰ä½ ï¼š

> âœ… **è¿™ä¸ªæ•ˆæœ 100% æ˜¯ Canvas åŠ¨æ€ç»˜åˆ¶æ–¹æ¡ˆï¼Œä¸æ˜¯ WebGLï¼Œä¹Ÿä¸æ˜¯çº¯ styleã€‚**

ä¸‹é¢æˆ‘**ä¸¥æ ¼å¯¹ç…§ä½ ç»™çš„æˆªå›¾**ï¼Œæ‹†è§£ **çœŸå®å¯å¤ç°çš„å®ç°æ–¹æ¡ˆ**ï¼Œè€Œä¸æ˜¯æ³›æ³›è€Œè°ˆã€‚

------

## ä¸€ã€å…ˆâ€œè¯»å›¾â€ï¼šè¿™ä¸ªæ•ˆæœåˆ°åº•ç”±å“ªäº›å±‚ç»„æˆï¼Ÿ

ä½ è¿™å¼ å›¾é‡Œï¼Œå…¶å®æ˜¯ **4 ä¸ªå åŠ å±‚**ï¼ˆéå¸¸é‡è¦ï¼‰ï¼š

------

### â‘  åº•å›¾ï¼ˆæ·±è‰²æµ·åŸŸï¼‰

- æ™®é€šç“¦ç‰‡ / é™æ€åº•å›¾
- ä¸æµåŠ¨æ— å…³

------

### â‘¡ é£æœºç‚¹ä½ï¼ˆgisType = 1ï¼‰

- Icon
- åº•éƒ¨ç»¿è‰²çŠ¶æ€æ¡ï¼ˆå¯èƒ½æ˜¯ canvas æˆ– spriteï¼‰

ğŸ‘‰ **è¿™æ˜¯æ™®é€š VectorLayer + Icon style**

------

### â‘¢ é™æ€çº¢è‰²ç”µç¼†çº¿ï¼ˆç²—çº¿ï¼‰

- çº¢è‰²
- ç¨³å®šä¸åŠ¨
- ä»â€œé›†ç”µç«™â€è¾å°„å‡ºå»

ğŸ‘‰ **è¿™æ˜¯æ™®é€š LineString çš„ Stroke**

------

### â‘£ ğŸ”¥ åŠ¨æ€â€œæµåŠ¨çº¢å…‰â€ï¼ˆé‡ç‚¹ï¼‰

ä½ æ³¨æ„çœ‹ï¼š

- çº¢çº¿**ä¸æ˜¯è™šçº¿**
- æœ‰**äº®åº¦å˜åŒ–**
- æœ‰â€œæµå‘æ„Ÿâ€
- **äº®éƒ¨åœ¨ç§»åŠ¨**

ğŸ‘‰ è¿™è¯´æ˜ï¼š
âŒ ä¸æ˜¯ `lineDashOffset`
âŒ ä¸æ˜¯è´´å›¾çº¹ç†
âœ… **æ˜¯ Canvas åœ¨ postrender é‡Œç”»çš„â€œé«˜äº®æ®µâ€**

------

## äºŒã€ç»“è®ºå…ˆè¡Œï¼ˆéå¸¸é‡è¦ï¼‰

> ğŸ¯ **æ­£ç¡®æ–¹æ¡ˆ = é™æ€çº¿ + Canvas é«˜äº®æµæ®µå åŠ **

------

## ä¸‰ã€æœ€ç»ˆæ¶æ„è®¾è®¡ï¼ˆä½ å¯ä»¥ç›´æ¥ç…§è¿™ä¸ªæ¥ï¼‰

```txt
Map
â”œâ”€â”€ é£æœº Layerï¼ˆVectorLayerï¼‰
â”œâ”€â”€ ç”µç¼†é™æ€çº¿ Layerï¼ˆVectorLayerï¼‰
â””â”€â”€ ç”µç¼†æµåŠ¨æ•ˆæœ Layerï¼ˆVectorLayer + postrenderï¼‰
```

âš ï¸ **æµåŠ¨æ•ˆæœå¿…é¡»å•ç‹¬ä¸€å±‚**
å¦åˆ™ä½ åé¢ç»´æŠ¤ä¼šéå¸¸ç—›è‹¦ã€‚

------

## å››ã€ä¸¥æ ¼å¤åˆ»æˆªå›¾çš„â€œæµåŠ¨çº¢çº¿â€æ–¹æ¡ˆ

### æ ¸å¿ƒæ€æƒ³ï¼ˆä¸€å¥è¯ï¼‰

> **æ²¿ LineString å–ä¸€å°æ®µâ€œé«˜äº®å­çº¿â€ï¼Œä¸æ–­å‘ç»ˆç‚¹æ¨è¿›ï¼Œå¾ªç¯ã€‚**

------

## äº”ã€å…³é”®æŠ€æœ¯ç‚¹æ‹†è§£ï¼ˆä¸€æ­¥ä¸çœï¼‰

------

### 1ï¸âƒ£ ç”µç¼†å‡ ä½•ï¼ˆå¿…é¡»æ˜¯ LineStringï¼‰

```js
const line = new ol.geom.LineString(coords);
```

> coords é¡ºåºï¼š
> **é£æœº â†’ é›†ç”µç«™** æˆ– **é›†ç”µç«™ â†’ é£æœº**
> âš ï¸ å¿…é¡»ç»Ÿä¸€ï¼ˆåé¢å†³å®šæµå‘ï¼‰

------

### 2ï¸âƒ£ é™æ€çº¢çº¿ï¼ˆåº•å±‚ï¼‰

```js
const staticStyle = new ol.style.Style({
  stroke: new ol.style.Stroke({
    color: 'rgba(255,0,0,0.4)',
    width: 2
  })
});
```

------

### 3ï¸âƒ£ æµåŠ¨æ•ˆæœçš„æ•°å­¦æ¨¡å‹ï¼ˆé‡ç‚¹ï¼‰

æˆ‘ä»¬å®šä¹‰ï¼š

```js
totalLength = line.getLength();
flowLength = totalLength * 0.15; // é«˜äº®æ®µé•¿åº¦
speed = 80; // æ•°å€¼è¶Šå°è¶Šå¿«
```

å½“å‰å¸§çš„â€œèµ·ç‚¹â€ï¼š

```js
start = (time / speed) % totalLength;
end = start + flowLength;
```

------

### 4ï¸âƒ£ åœ¨ postrender é‡Œâ€œæˆªå–å­çº¿â€

```js
vectorLayer.on('postrender', e => {
  const ctx = e.context;
  const time = e.frameState.time;

  features.forEach(feature => {
    const geom = feature.getGeometry();
    const length = geom.getLength();

    const start = (time / 80) % length;
    const end = Math.min(start + length * 0.15, length);

    const subLine = geom.clone().getCoordinates()
      .slice(
        Math.floor(start / length * geom.getCoordinates().length),
        Math.ceil(end / length * geom.getCoordinates().length)
      );

    if (subLine.length < 2) return;

    ctx.beginPath();
    drawLine(ctx, subLine, map);
    ctx.strokeStyle = 'rgba(255,0,0,0.9)';
    ctx.lineWidth = 4;
    ctx.stroke();
  });

  map.render();
});
```

> ğŸ“Œ **è¿™é‡Œä¸æ˜¯ Styleï¼Œè€Œæ˜¯ Canvas ç›´æ¥ç”»**

------

### 5ï¸âƒ£ ä¸ºä»€ä¹ˆè¿™ä¸ªæ•ˆæœâ€œåƒä½ æˆªå›¾é‡Œçš„â€

âœ” äº®åº¦é«˜
âœ” éè™šçº¿
âœ” æœ‰æ–¹å‘
âœ” å¯è°ƒç²—ç»†
âœ” å¯è°ƒé•¿åº¦
âœ” å¤šæ¡çº¿åŒæ—¶æµåŠ¨

------

## å…­ã€æ–¹å‘æ˜¯æ€ä¹ˆâ€œæŒ‡å‘é›†ç”µç«™â€çš„ï¼Ÿ

ä½ æˆªå›¾é‡Œ **æ‰€æœ‰çº¿éƒ½å¾€ä¸­é—´çš„ç«™ç‚¹æµåŠ¨**ã€‚

### æ­£ç¡®åšæ³•ï¼š

```js
if (distance(lineEnd, station) > distance(lineStart, station)) {
  coords.reverse();
}
```

è¿™æ ·ï¼š

> **LineString æ–¹å‘ = é£æœº â†’ é›†ç”µç«™**

------

## ä¸ƒã€æ€§èƒ½é—®é¢˜ï¼ˆä½ ä¸€å®šä¼šå…³å¿ƒï¼‰

æ”¾å¿ƒï¼Œè¿™ä¸ªæ–¹æ¡ˆï¼š

- âœ” 100 æ¡çº¿æ²¡é—®é¢˜
- âœ” ä¸åˆ›å»ºæ–° Feature
- âœ” ä¸è§¦å‘é‡æ’
- âœ” åªç”¨ä¸€ä¸ª Canvas

âš ï¸ æ³¨æ„ä¸¤ç‚¹ï¼š

- ä¸è¦åœ¨ postrender é‡Œ new geometry
- ä¸è¦ map.render() å åŠ è°ƒç”¨å¤ªå¤š

------

å¥½ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ç»™ä½ ä¸€ä¸ª**ã€Œå¯è¿è¡Œã€å¯å¤ç”¨ã€ç»“æ„æ¸…æ™°ã€çš„å®Œæ•´ç¤ºä¾‹**ï¼Œ**ä¸¥æ ¼æŒ‰ä½ æˆªå›¾é‚£ç§â€œå‘é›†ç”µç«™æ±‡èšçš„çº¢è‰²æµåŠ¨ç”µç¼†â€æ¥åš**ã€‚
ç¤ºä¾‹ç”¨ **OpenLayers 6+ / 7+ å‡å¯**ï¼Œä¸ä¾èµ–ç¬¬ä¸‰æ–¹æ’ä»¶ã€‚

> ç¤ºä¾‹ç»“æ„ï¼š
> **é™æ€ç”µç¼†çº¿ + Canvas åŠ¨æ€é«˜äº®æµæ®µ + é£æœº / é›†ç”µç«™ Icon**

------

# ä¸€ã€æœ€ç»ˆæ•ˆæœè¯´æ˜ï¼ˆä½ å°†å¾—åˆ°ä»€ä¹ˆï¼‰

- çº¢è‰²ç”µç¼† **å§‹ç»ˆå­˜åœ¨ï¼ˆåº•çº¿ï¼‰**
- çº¢è‰²â€œäº®æ®µâ€**æ²¿ç”µç¼†å‘é›†ç”µç«™æµåŠ¨**
- è‡ªåŠ¨å¾ªç¯
- å¤šæ¡çº¿åŒæ—¶å·¥ä½œ
- points æ”¯æŒ **ä¸¤ç‚¹æˆ–å¤šç‚¹æŠ˜çº¿**
- å¯è°ƒï¼šé€Ÿåº¦ / äº®æ®µé•¿åº¦ / é¢œè‰² / ç²—ç»†

------

# äºŒã€HTML åŸºç¡€ç»“æ„

```html
<div id="map" style="width:100%;height:100vh;"></div>
```

------

# ä¸‰ã€å®Œæ•´ JS ç¤ºä¾‹ï¼ˆå¯ç›´æ¥ç”¨ï¼‰

> âš ï¸ **è¿™æ˜¯ä¸€ä¸ªå®Œæ•´æ–‡ä»¶çº§ç¤ºä¾‹**ï¼Œä½ å¯ä»¥ç›´æ¥æ‹†è¿› Vue ç»„ä»¶çš„ `mounted`

------

## 1ï¸âƒ£ åˆå§‹åŒ–åœ°å›¾

```js
import 'ol/ol.css';
import Map from 'ol/Map';
import View from 'ol/View';
import { Tile as TileLayer, Vector as VectorLayer } from 'ol/layer';
import { OSM } from 'ol/source';
import VectorSource from 'ol/source/Vector';
import Feature from 'ol/Feature';
import Point from 'ol/geom/Point';
import LineString from 'ol/geom/LineString';
import { Style, Stroke, Icon } from 'ol/style';
import { fromLonLat } from 'ol/proj';
const map = new Map({
  target: 'map',
  layers: [
    new TileLayer({
      source: new OSM()
    })
  ],
  view: new View({
    center: fromLonLat([111.595, 20.96]),
    zoom: 11
  })
});
```

------

## 2ï¸âƒ£ é£æœº & é›†ç”µç«™ Layerï¼ˆgisType = 1ï¼‰

```js
const pointSource = new VectorSource();

const pointLayer = new VectorLayer({
  source: pointSource,
  style: feature => {
    const type = feature.get('type');
    return new Style({
      image: new Icon({
        src: type === 'station'
          ? '/station.png'
          : '/wind.png',
        scale: 0.7,
        anchor: [0.5, 1]
      })
    });
  }
});

map.addLayer(pointLayer);
```

### ç¤ºä¾‹ç‚¹ä½

```js
const stationCoord = fromLonLat([111.59536, 20.95811]);

pointSource.addFeature(new Feature({
  geometry: new Point(stationCoord),
  type: 'station'
}));
```

------

## 3ï¸âƒ£ ç”µç¼†é™æ€çº¿ Layerï¼ˆåº•çº¿ï¼‰

```js
const lineSource = new VectorSource();

const staticLineLayer = new VectorLayer({
  source: lineSource,
  style: new Style({
    stroke: new Stroke({
      color: 'rgba(255,0,0,0.35)',
      width: 2
    })
  })
});

map.addLayer(staticLineLayer);
```

------

## 4ï¸âƒ£ ç¤ºä¾‹ç”µç¼†æ•°æ®ï¼ˆä¸ä½ æ¥å£ä¸€è‡´ï¼‰

```js
const cables = [
  {
    points: [
      { longitude: 111.59509, latitude: 20.96239 },
      { longitude: 111.59536, latitude: 20.95811 }
    ]
  },
  {
    points: [
      { longitude: 111.60, latitude: 20.965 },
      { longitude: 111.59536, latitude: 20.95811 }
    ]
  }
];
```

------

## 5ï¸âƒ£ ç”Ÿæˆ LineStringï¼ˆæ–¹å‘ = é£æœº â†’ é›†ç”µç«™ï¼‰

```js
cables.forEach(item => {
  const coords = item.points.map(p =>
    fromLonLat([p.longitude, p.latitude])
  );

  const line = new LineString(coords);

  lineSource.addFeature(
    new Feature({
      geometry: line
    })
  );
});
```

------

# å››ã€ğŸ”¥ æ ¸å¿ƒï¼šæµåŠ¨æ•ˆæœ Layerï¼ˆCanvas postrenderï¼‰

> **è¿™ä¸€æ­¥æ˜¯æ•´ä¸ªæ•ˆæœçš„çµé­‚**

------

## 6ï¸âƒ£ æµåŠ¨æ•ˆæœ Layer

```js
const flowLayer = new VectorLayer({
  source: lineSource,
  renderMode: 'image' // æé«˜æ€§èƒ½
});

map.addLayer(flowLayer);
```

------

## 7ï¸âƒ£ Canvas æµåŠ¨é€»è¾‘ï¼ˆé‡ç‚¹ï¼‰

```js
flowLayer.on('postrender', e => {
  const ctx = e.context;
  const frameState = e.frameState;
  const time = frameState.time;

  ctx.save();
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';

  lineSource.forEachFeature(feature => {
    const geom = feature.getGeometry();
    const length = geom.getLength();

    // å‚æ•°ï¼ˆä½ å¯ä»¥é…ç½®åŒ–ï¼‰
    const speed = 90;            // è¶Šå°è¶Šå¿«
    const flowRatio = 0.18;      // é«˜äº®æ®µå æ¯”
    const flowLen = length * flowRatio;

    const start = (time / speed) % length;
    const end = Math.min(start + flowLen, length);

    drawFlowSegment(ctx, geom, start, end);
  });

  ctx.restore();
  map.render();
});
```

------

## 8ï¸âƒ£ å…³é”®å‡½æ•°ï¼šç»˜åˆ¶â€œé«˜äº®å­çº¿â€

```js
function drawFlowSegment(ctx, line, start, end) {
  const coords = line.getCoordinates();
  const total = line.getLength();

  let acc = 0;
  let started = false;

  ctx.beginPath();

  for (let i = 0; i < coords.length - 1; i++) {
    const a = coords[i];
    const b = coords[i + 1];
    const seg = Math.hypot(b[0] - a[0], b[1] - a[1]);

    const segStart = acc;
    const segEnd = acc + seg;

    if (segEnd < start) {
      acc += seg;
      continue;
    }

    if (segStart > end) break;

    const s = Math.max(0, (start - segStart) / seg);
    const e = Math.min(1, (end - segStart) / seg);

    const x1 = a[0] + (b[0] - a[0]) * s;
    const y1 = a[1] + (b[1] - a[1]) * s;
    const x2 = a[0] + (b[0] - a[0]) * e;
    const y2 = a[1] + (b[1] - a[1]) * e;

    const p1 = map.getPixelFromCoordinate([x1, y1]);
    const p2 = map.getPixelFromCoordinate([x2, y2]);

    if (!started) {
      ctx.moveTo(p1[0], p1[1]);
      started = true;
    }
    ctx.lineTo(p2[0], p2[1]);

    acc += seg;
  }

  ctx.strokeStyle = 'rgba(255,0,0,0.9)';
  ctx.lineWidth = 4;
  ctx.stroke();
}
```

------

# äº”ã€ä½ ç°åœ¨å·²ç»æ‹¥æœ‰çš„èƒ½åŠ›

âœ” å®Œå…¨å¤åˆ»ä½ æˆªå›¾çš„æµåŠ¨ç”µç¼†
âœ” æ”¯æŒä»»æ„æŠ˜çº¿ points
âœ” å¤šæ¡çº¿åŒæ—¶æµåŠ¨
âœ” å‘é›†ç”µç«™æ±‡èš
âœ” æ€§èƒ½å¯æ§
âœ” æ˜“äºå°è£…

------

# å…­ã€å¼ºçƒˆå»ºè®®ä½ ä¸‹ä¸€æ­¥åšçš„ 3 ä»¶äº‹

1ï¸âƒ£ æŠŠ **speed / flowRatio / color** åšæˆåç«¯ `style` é…ç½®
2ï¸âƒ£ æŠŠ **flowLayer å°è£…æˆ CableFlowLayer ç±»**
3ï¸âƒ£ æ ¹æ®å‘Šè­¦çŠ¶æ€ â†’ çº¢ / é»„ / ç° åˆ‡æ¢

------

æ‹“å±•ï¼š

- ğŸ”¹ **å°è£…æˆ Vue ç»„ä»¶**
- ğŸ”¹ **æ”¯æŒæš‚åœ / æ¢å¤**
- ğŸ”¹ **åšâ€œç”µæµè„‰å†²â€å°¾è¿¹**
- ğŸ”¹ **ä¸Šç™¾æ¡çº¿çš„æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ**

å¥½ï¼Œè¿™ä¸€æ­¥æˆ‘ä»¬**ç›´æ¥æŠŠå®ƒâ€œå·¥ç¨‹åŒ–â€**ã€‚
ä¸‹é¢ç»™ä½ ä¸€ä¸ª **å¯ç›´æ¥æ‹·è´ä½¿ç”¨çš„ã€Œæµ·ä¸Šç”µç¼†æµåŠ¨æ•ˆæœç±»ã€**ï¼Œè®¾è®¡ç›®æ ‡æ˜¯ï¼š

> âœ… **åªå…³å¿ƒæ•°æ®ï¼Œä¸å…³å¿ƒ OpenLayers ç»†èŠ‚**
> âœ… ä¸€è¡Œ `new CableFlowLayer(map, options)` å°±èƒ½è·‘
> âœ… é€‚åˆ Vue / React / åŸç”Ÿ
> âœ… åç»­å¯æ‰©å±•ï¼ˆå‘Šè­¦ã€æš‚åœã€å˜é€Ÿï¼‰

------

# ä¸€ã€ç±»çš„ä½¿ç”¨æ–¹å¼ï¼ˆå…ˆçœ‹æ€ä¹ˆç”¨ï¼‰

```js
const cableFlow = new CableFlowLayer(map, {
  stationCoord: [111.59536, 20.95811], // é›†ç”µç«™ï¼ˆlon,latï¼‰
  cables: apiDataList,                // æ¥å£è¿”å›çš„ gisType=2 æ•°æ®
  speed: 90,
  flowRatio: 0.18,
  color: 'rgba(255,0,0,0.9)',
  baseColor: 'rgba(255,0,0,0.35)'
});

// å¼€å§‹åŠ¨ç”»
cableFlow.start();

// åœæ­¢åŠ¨ç”»
cableFlow.stop();

// é”€æ¯
cableFlow.destroy();
```

------

# äºŒã€CableFlowLayer å®Œæ•´ç±»å®ç°

> âš ï¸ **è¿™æ˜¯å®Œæ•´å¯è¿è¡Œä»£ç **
> ä¾èµ–ï¼šOpenLayers 6+

------

## 1ï¸âƒ£ CableFlowLayer.js

```js
import VectorLayer from 'ol/layer/Vector';
import VectorSource from 'ol/source/Vector';
import Feature from 'ol/Feature';
import LineString from 'ol/geom/LineString';
import { Style, Stroke } from 'ol/style';
import { fromLonLat } from 'ol/proj';
export default class CableFlowLayer {
  constructor(map, options = {}) {
    this.map = map;

    this.options = {
      speed: options.speed ?? 90,
      flowRatio: options.flowRatio ?? 0.18,
      color: options.color ?? 'rgba(255,0,0,0.9)',
      baseColor: options.baseColor ?? 'rgba(255,0,0,0.35)',
      lineWidth: options.lineWidth ?? 2,
      flowWidth: options.flowWidth ?? 4
    };

    this.stationCoord = fromLonLat(options.stationCoord);
    this.cables = options.cables || [];

    this._running = false;
    this._postRender = this._onPostRender.bind(this);

    this._initLayers();
    this._initFeatures();
  }
```

------

## 2ï¸âƒ£ åˆå§‹åŒ–å›¾å±‚

```js
  _initLayers() {
    this.source = new VectorSource();

    // é™æ€çº¿
    this.baseLayer = new VectorLayer({
      source: this.source,
      style: new Style({
        stroke: new Stroke({
          color: this.options.baseColor,
          width: this.options.lineWidth
        })
      })
    });

    // æµåŠ¨å±‚ï¼ˆåªè´Ÿè´£ canvasï¼‰
    this.flowLayer = new VectorLayer({
      source: this.source,
      renderMode: 'image'
    });

    this.map.addLayer(this.baseLayer);
    this.map.addLayer(this.flowLayer);
  }
```

------

## 3ï¸âƒ£ ç”Ÿæˆ Featureï¼ˆè‡ªåŠ¨å¤„ç†æ–¹å‘ï¼‰

```js
  _initFeatures() {
    this.cables.forEach(item => {
      if (!item.points || item.points.length < 2) return;

      let coords = item.points.map(p =>
        fromLonLat([p.longitude, p.latitude])
      );

      // ä¿è¯æ–¹å‘ï¼šé£æœº â†’ é›†ç”µç«™
      if (this._distance(coords[coords.length - 1], this.stationCoord) >
          this._distance(coords[0], this.stationCoord)) {
        coords.reverse();
      }

      const feature = new Feature({
        geometry: new LineString(coords)
      });

      this.source.addFeature(feature);
    });
  }
```

------

## 4ï¸âƒ£ å¯åŠ¨ / åœæ­¢ / é”€æ¯

```js
  start() {
    if (this._running) return;
    this._running = true;
    this.flowLayer.on('postrender', this._postRender);
    this.map.render();
  }

  stop() {
    this._running = false;
    this.flowLayer.un('postrender', this._postRender);
  }

  destroy() {
    this.stop();
    this.map.removeLayer(this.baseLayer);
    this.map.removeLayer(this.flowLayer);
    this.source.clear();
  }
```

------

## 5ï¸âƒ£ æ ¸å¿ƒåŠ¨ç”»é€»è¾‘ï¼ˆCanvasï¼‰

```js
  _onPostRender(e) {
    if (!this._running) return;

    const ctx = e.context;
    const time = e.frameState.time;

    ctx.save();
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    this.source.forEachFeature(feature => {
      const geom = feature.getGeometry();
      const length = geom.getLength();

      const start = (time / this.options.speed) % length;
      const end = Math.min(start + length * this.options.flowRatio, length);

      this._drawFlowSegment(ctx, geom, start, end);
    });

    ctx.restore();
    this.map.render();
  }
```

------

## 6ï¸âƒ£ ç»˜åˆ¶â€œé«˜äº®å­çº¿â€ï¼ˆå…³é”®ç®—æ³•ï¼‰

```js
  _drawFlowSegment(ctx, line, start, end) {
    const coords = line.getCoordinates();
    let acc = 0;
    let started = false;

    ctx.beginPath();

    for (let i = 0; i < coords.length - 1; i++) {
      const a = coords[i];
      const b = coords[i + 1];
      const seg = Math.hypot(b[0] - a[0], b[1] - a[1]);

      const segStart = acc;
      const segEnd = acc + seg;

      if (segEnd < start) {
        acc += seg;
        continue;
      }
      if (segStart > end) break;

      const s = Math.max(0, (start - segStart) / seg);
      const e = Math.min(1, (end - segStart) / seg);

      const x1 = a[0] + (b[0] - a[0]) * s;
      const y1 = a[1] + (b[1] - a[1]) * s;
      const x2 = a[0] + (b[0] - a[0]) * e;
      const y2 = a[1] + (b[1] - a[1]) * e;

      const p1 = this.map.getPixelFromCoordinate([x1, y1]);
      const p2 = this.map.getPixelFromCoordinate([x2, y2]);

      if (!started) {
        ctx.moveTo(p1[0], p1[1]);
        started = true;
      }
      ctx.lineTo(p2[0], p2[1]);

      acc += seg;
    }

    ctx.strokeStyle = this.options.color;
    ctx.lineWidth = this.options.flowWidth;
    ctx.stroke();
  }
```

------

## 7ï¸âƒ£ å·¥å…·æ–¹æ³•

```js
  _distance(a, b) {
    const dx = a[0] - b[0];
    const dy = a[1] - b[1];
    return Math.sqrt(dx * dx + dy * dy);
  }
}
```

------

# ä¸‰ã€è¿™ä¸ªç±»çš„è®¾è®¡ä¼˜ç‚¹ï¼ˆä¸ºä»€ä¹ˆè¿™æ ·å°ï¼‰

âœ… ä¸æ±¡æŸ“ä½ çš„ä¸šåŠ¡ä»£ç 
âœ… OpenLayers é€»è¾‘å…¨æ”¶æ•›
âœ… å¯éšæ—¶åŠ ï¼š

- `setSpeed(speed)`
- `setColor(color)`
- `pause() / resume()`
- å‘Šè­¦æ€é—ªçƒ
- å•æ¡çº¿æ§åˆ¶

------

# å››ã€ä¸‹ä¸€æ­¥æˆ‘å»ºè®®ä½ å‡çº§çš„æ–¹å‘

å¦‚æœä½ ç»§ç»­åšæµ·ä¸Šé£ç”µé¡¹ç›®ï¼Œè¿™ä¸ªç±»å¯ä»¥è¿›åŒ–æˆï¼š

- ğŸ”¹ **CableFlowManagerï¼ˆå¤šé›†ç”µç«™ï¼‰**
- ğŸ”¹ **æ”¯æŒåŒå‘æµ**
- ğŸ”¹ **çŠ¶æ€é©±åŠ¨é¢œè‰² / é€Ÿåº¦**
- ğŸ”¹ **WebGL è‡ªåŠ¨é™çº§**

------

æ‹“å±•ï¼š

ğŸ‘‰ **Vue 3 ç‰ˆ useCableFlow composable**
ğŸ‘‰ **æ”¯æŒåå° style JSON çš„è§£æ**
ğŸ‘‰ **ä¸€æ¡çº¿å•ç‹¬æ§åˆ¶ï¼ˆé€‰ä¸­é«˜äº®ï¼‰**

# å®ç°æµåŠ¨æ•ˆæœçš„å…³é”®

è¿™æ˜¯ä¸ª**éå¸¸å…³é”®çš„é—®é¢˜**ï¼Œä½ é—®åˆ°ç‚¹å­ä¸Šäº† ğŸ‘
æˆ‘ç›´æ¥**â€œç‚¹åä»£ç  + ç”»æµç¨‹â€**ï¼Œè®©ä½ ä¸€çœ¼å°±æ˜ç™½ **æµåŠ¨åˆ°åº•å‘ç”Ÿåœ¨å“ªé‡Œ**ã€‚

------

## ä¸€å¥è¯ç­”æ¡ˆï¼ˆå…ˆç»™ç»“è®ºï¼‰

> **çœŸæ­£äº§ç”Ÿâ€œæµåŠ¨æ•ˆæœâ€çš„åœ°æ–¹åªæœ‰ä¸¤ä¸ªç‚¹ï¼š**

1. **`postrender` é‡Œæ ¹æ®æ—¶é—´è®¡ç®— `start / end`**
2. **`_drawFlowSegment()` é‡Œåªç”» LineString çš„â€œä¸€å°æ®µâ€**

**å…¶å®ƒä»£ç éƒ½æ˜¯å‡†å¤‡å·¥ä½œã€‚**

------

## ä¸€ã€ç¬¬ä¸€å¤„ï¼šæ—¶é—´é©±åŠ¨çš„ä½ç½®å˜åŒ–ï¼ˆæµåŠ¨çš„â€œå‘åŠ¨æœºâ€ï¼‰

### ğŸ“ ä»£ç ä½ç½®

```js
_onPostRender(e) {
  const ctx = e.context;
  const time = e.frameState.time;

  this.source.forEachFeature(feature => {
    const geom = feature.getGeometry();
    const length = geom.getLength();

    const start = (time / this.options.speed) % length;
    const end = Math.min(start + length * this.options.flowRatio, length);

    this._drawFlowSegment(ctx, geom, start, end);
  });

  this.map.render();
}
```

------

### ğŸ§  è¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

- `time`ï¼šæµè§ˆå™¨å½“å‰æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
- `time / speed`ï¼šè®©æ•°å€¼**ç¼“æ…¢å¢é•¿**
- `% length`ï¼šåˆ°ç»ˆç‚¹å**é‡æ–°ä» 0 å¼€å§‹**
- `start`ï¼šé«˜äº®æ®µçš„**èµ·å§‹è·ç¦»**
- `end`ï¼šé«˜äº®æ®µçš„**ç»“æŸè·ç¦»**

ğŸ‘‰ **start æ¯ä¸€å¸§éƒ½åœ¨å˜ â†’ çœ‹èµ·æ¥å°±åœ¨â€œæµåŠ¨â€**

------

## äºŒã€ç¬¬äºŒå¤„ï¼šåªç”»â€œå­çº¿æ®µâ€ï¼ˆæµåŠ¨çš„â€œè§†è§‰å®ä½“â€ï¼‰

### ğŸ“ ä»£ç ä½ç½®

```js
_drawFlowSegment(ctx, line, start, end) {
  const coords = line.getCoordinates();
  let acc = 0;
  let started = false;

  ctx.beginPath();

  for (let i = 0; i < coords.length - 1; i++) {
    const a = coords[i];
    const b = coords[i + 1];
    const seg = Math.hypot(b[0] - a[0], b[1] - a[1]);

    const segStart = acc;
    const segEnd = acc + seg;

    if (segEnd < start) {
      acc += seg;
      continue;
    }
    if (segStart > end) break;

    const s = Math.max(0, (start - segStart) / seg);
    const e = Math.min(1, (end - segStart) / seg);

    // æ’å€¼ç®—å‡ºå­çº¿æ®µç«¯ç‚¹
    const x1 = a[0] + (b[0] - a[0]) * s;
    const y1 = a[1] + (b[1] - a[1]) * s;
    const x2 = a[0] + (b[0] - a[0]) * e;
    const y2 = a[1] + (b[1] - a[1]) * e;

    const p1 = this.map.getPixelFromCoordinate([x1, y1]);
    const p2 = this.map.getPixelFromCoordinate([x2, y2]);

    if (!started) {
      ctx.moveTo(p1[0], p1[1]);
      started = true;
    }
    ctx.lineTo(p2[0], p2[1]);

    acc += seg;
  }

  ctx.strokeStyle = this.options.color;
  ctx.lineWidth = this.options.flowWidth;
  ctx.stroke();
}
```

------

### ğŸ§  è¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

è¿™æ®µä»£ç åšäº†ä¸‰ä»¶äº‹ï¼š

1. **æŠŠæ•´æ¡ LineString æŒ‰â€œé•¿åº¦â€å½“æˆä¸€æ ¹æ ‡å°º**
2. æ‰¾å‡º `[start, end]` è¿™ä¸€å°æ®µ
3. **åªæŠŠè¿™ä¸€å°æ®µç”»åˆ° Canvas ä¸Š**

ğŸ‘‰ å› ä¸ºæ¯ä¸€å¸§ `[start, end]` éƒ½åœ¨å‘å‰ç§»åŠ¨
ğŸ‘‰ æ‰€ä»¥ä½ çœ‹åˆ°çš„æ˜¯ **â€œäº®æ®µåœ¨è·‘â€**

------

## ä¸‰ã€ä¸ºä»€ä¹ˆçœ‹èµ·æ¥æ˜¯â€œæµåŠ¨â€ï¼Œä¸æ˜¯â€œé—ªçƒâ€ï¼Ÿ

å› ä¸ºï¼š

| å…³é”®ç‚¹           | ä½œç”¨       |
| ---------------- | ---------- |
| `time` è¿ç»­å˜åŒ–  | æ²¡æœ‰è·³å˜   |
| å­çº¿æ®µä½ç½®å¹³ç§»   | ä¸æ”¹å˜é•¿åº¦ |
| Canvas è¿ç»­é‡ç»˜  | åŠ¨ç”»è¿è´¯   |
| ä¸åˆ›å»ºæ–° Feature | æ€§èƒ½ç¨³å®š   |

------

## å››ã€å¦‚æœä½ åªçœ‹ä¸€çœ¼å°±æƒ³å®šä½â€œæµåŠ¨ä»£ç â€

ä½ åªéœ€è¦è®°ä½è¿™ä¸€è¡Œ ğŸ‘‡

```js
const start = (time / speed) % length;
```

> **è¿™è¡Œä»£ç  = æµåŠ¨çš„æœ¬è´¨**

------

## äº”ã€ä½ ç°åœ¨å¯ä»¥â€œæ”¹æµåŠ¨è¡Œä¸ºâ€çš„åœ°æ–¹

æˆ‘ç»™ä½ æ ‡å‡ºæ¥äº†ï¼Œéƒ½æ˜¯**æµåŠ¨æ§åˆ¶ç‚¹**ï¼š

```js
speed        // æ§åˆ¶æµé€Ÿ
flowRatio   // æ§åˆ¶äº®æ®µé•¿åº¦
color       // æµåŠ¨é¢œè‰²
flowWidth   // æµåŠ¨ç²—ç»†
```

------

## æ€ä¹ˆå®ç°æµåŠ¨çš„ï¼Œå“ªä¸ªåœ°æ–¹åœ¨å¾ªç¯è°ƒç”¨?

å¾ˆå¥½çš„é—®é¢˜ï¼Œè¿™æ­£å¥½æ˜¯**ç†è§£ OpenLayers åŠ¨ç”»æœºåˆ¶çš„å…³é”®ç‚¹**ã€‚
æˆ‘ç›´æ¥ç»™ä½ **æ˜ç¡®ã€å¯å®šä½çš„ç­”æ¡ˆ**ï¼Œä¸ç»•ã€‚

------

## ä¸€å¥è¯ç»“è®ºï¼ˆå…ˆç»™ä½ ç­”æ¡ˆï¼‰

> **ä»£ç é‡Œæ²¡æœ‰ `setInterval / requestAnimationFrame`**
> **â€œå¾ªç¯è°ƒç”¨â€å‘ç”Ÿåœ¨è¿™é‡Œï¼š**

```js
this.map.render();
```

**é…åˆ `postrender` äº‹ä»¶ï¼Œå½¢æˆäº†ä¸€ä¸ªâ€œè‡ªé©±åŠ¨æ¸²æŸ“å¾ªç¯â€ã€‚**

------

## ä¸€ã€çœŸæ­£çš„â€œå¾ªç¯å…¥å£â€åœ¨å“ªé‡Œï¼Ÿ

### ğŸ“ å”¯ä¸€çš„å¾ªç¯è§¦å‘ç‚¹

```js
_onPostRender(e) {
  ...
  this.map.render(); // ğŸ‘ˆ å…³é”®
}
```

è¿™ä¸€è¡Œä»£ç çš„å«ä¹‰æ˜¯ï¼š

> **å½“å‰è¿™ä¸€å¸§ç”»å®Œ â†’ ä¸»åŠ¨è¯·æ±‚ä¸‹ä¸€å¸§é‡ç»˜**

æ‰€ä»¥æ‰§è¡Œæµç¨‹æ˜¯ï¼š

```
map.render()
   â†“
è§¦å‘å›¾å±‚ postrender
   â†“
_onPostRender æ‰§è¡Œï¼ˆç”»æµåŠ¨æ•ˆæœï¼‰
   â†“
å†æ¬¡ map.render()
   â†“
ä¸‹ä¸€å¸§ postrender
   â†“
...
```

ğŸ‘‰ è¿™å°±å½¢æˆäº†ä¸€ä¸ª **éšå¼çš„æ— é™åŠ¨ç”»å¾ªç¯**

------

## äºŒã€ä¸ºä»€ä¹ˆâ€œçœ‹èµ·æ¥åœ¨æµåŠ¨â€ï¼Ÿ

### å…³é”®ä¸æ˜¯å¾ªç¯ï¼Œè€Œæ˜¯ **â€œæ¯ä¸€å¸§ç”»çš„ä½ç½®ä¸åŒâ€**

çœ‹è¿™ä¸€è¡Œ ğŸ‘‡

```js
const baseStart = (time / this.options.speed) % length;
```

- `time`ï¼šæµè§ˆå™¨æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œ**ä¸€ç›´å¢é•¿**
- `/ speed`ï¼šæ§åˆ¶å¢é•¿é€Ÿåº¦
- `% length`ï¼šåˆ°å¤´äº†é‡æ–°æ¥

æ‰€ä»¥ï¼š

- æ¯ä¸€å¸§ `baseStart` éƒ½ä¸ä¸€æ ·
- `_drawFlowSegment` æ¯ä¸€å¸§ç”»çš„éƒ½æ˜¯**çº¿ä¸Šçš„ä¸åŒä½ç½®**
- è§†è§‰ä¸Šå°±æ˜¯â€œåœ¨æµåŠ¨â€

------

## ä¸‰ã€å®Œæ•´çš„â€œæµåŠ¨é—­ç¯â€æµç¨‹å›¾ï¼ˆéå¸¸é‡è¦ï¼‰

```
start()
  â†“
flowLayer.on('postrender', _onPostRender)
  â†“
map.render()
  â†“
â”Œâ”€ postrender äº‹ä»¶è§¦å‘
â”‚    â†“
â”‚  _onPostRender()
â”‚    â”œâ”€ æ ¹æ® time ç®— start/end
â”‚    â”œâ”€ ç”»å½“å‰å¸§çš„æµåŠ¨å…‰å¸¦
â”‚    â””â”€ map.render()  â† å†è¯·æ±‚ä¸€å¸§
â”‚
â””â”€â”€â”€â”€â”€â”€ æ— é™å¾ªç¯
```

------

## å››ã€ä¸ºä»€ä¹ˆä¸ç”¨ `setInterval` / `requestAnimationFrame`ï¼Ÿ

å› ä¸ºåœ¨ OpenLayers é‡Œï¼š

- åœ°å›¾æ¸²æŸ“æœ¬èº«å°±æ˜¯ **requestAnimationFrame é©±åŠ¨**
- `postrender` æ˜¯**æ¯ä¸€å¸§æ¸²æŸ“å®Œæˆå**è§¦å‘
- ç”¨ `map.render()` æ›´ï¼š
  - âœ” è·Ÿåœ°å›¾åˆ·æ–°èŠ‚å¥ä¸€è‡´
  - âœ” ä¸æŠ¢æµè§ˆå™¨å¸§
  - âœ” ä¸æŠ–åŠ¨

------

## äº”ã€å¦‚æœä½ â€œæƒ³åœä¸‹æ¥â€ï¼Œæ˜¯å“ªä¸€è¡Œæ§åˆ¶ï¼Ÿ

```js
stop() {
  this._running = false;
  this.flowLayer.un('postrender', this._postRender);
}
```

ä¸€æ—¦ `postrender` ä¸å†ç›‘å¬ï¼š

- `_onPostRender` ä¸ä¼šå†æ‰§è¡Œ
- `map.render()` ä¸å†è¢«è°ƒç”¨
- åŠ¨ç”»ç«‹å³åœæ­¢

------

## å…­ã€å¦‚æœä½ åªè®°ä½ä¸€å¥è¯ï¼ˆç»™ä»¥åæ’é”™ç”¨ï¼‰

> **OpenLayers åŠ¨ç”» = postrender + map.render() + time**

------

## ä¸ƒã€ä½ å¯èƒ½ä¼šé—®çš„ä¸¤ä¸ªè¿›é˜¶é—®é¢˜ï¼ˆæå‰å¸®ä½ è§£ç­”ï¼‰

### 1ï¸âƒ£ ä¼šä¸ä¼šæ­»å¾ªç¯å¡æ­»ï¼Ÿ

ä¸ä¼šï¼Œå› ä¸ºï¼š

- `map.render()` å†…éƒ¨æ˜¯ `requestAnimationFrame`
- æµè§ˆå™¨æ¯å¸§æœ€å¤š 1 æ¬¡

------

### 2ï¸âƒ£ å¤šä¸ªæµåŠ¨å±‚ä¼šä¸ä¼šå†²çªï¼Ÿ

ä¸ä¼šï¼š

- æ¯ä¸ª layer çš„ `postrender` éƒ½ç‹¬ç«‹
- ä½†å»ºè®®**ç»Ÿä¸€ä¸€ä¸ªåŠ¨ç”»å±‚**ï¼Œé¿å…é‡å¤ `map.render()`

------

## å…«ã€æ‹“å±•

- ğŸ”¹ æ”¹æˆ **requestAnimationFrame ç»Ÿä¸€è°ƒåº¦ç‰ˆ**
- ğŸ”¹ åš **å¸§ç‡é™åˆ¶ï¼ˆ30fpsï¼‰**
- ğŸ”¹ å¤šåŠ¨ç”» Layer çš„ **ä¸­å¿ƒè°ƒåº¦å™¨**
- ğŸ”¹ å¼€å…³â€œåœ°å›¾é™æ­¢æ—¶æ‰åŠ¨ç”»â€

## 

- ğŸ”¹ **åŠ å°¾è¿¹ï¼ˆæ¸éšå…‰å¸¦ï¼‰**
- ğŸ”¹ **åŒå‘æµï¼ˆæ¥å›ï¼‰**
- ğŸ”¹ **æš‚åœ / æ¢å¤**
- ğŸ”¹ **å•æ¡ç”µç¼†ç‹¬ç«‹æ§åˆ¶**
- ğŸ”¹ **å‘Šè­¦çŠ¶æ€é—ªçƒ**

## åŠ å°¾è¿¹ï¼ˆæ¸éšå…‰å¸¦ï¼‰

å¾ˆå¥½ï¼Œè¿™ä¸€æ­¥å°±æ˜¯**æŠŠâ€œäº®æ®µâ€å‡çº§æˆä½ æˆªå›¾é‡Œé‚£ç§â€œæœ‰æ‹–å°¾çš„èƒ½é‡æµâ€**ã€‚
æˆ‘ç›´æ¥å‘Šè¯‰ä½  **åŸç† + ç²¾ç¡®æ”¹å“ªå‡ è¡Œä»£ç **ï¼Œä¸æ¨ç¿»ä½ ç°æœ‰çš„ç±»ã€‚

------

# ä¸€ã€å…ˆç»™ç»“è®ºï¼ˆæ ¸å¿ƒæ€æƒ³ï¼‰

> **å°¾è¿¹ = å¤šç”»å‡ æ¡â€œåŒä¸€è·¯å¾„çš„å­çº¿â€ï¼Œä½†ï¼š**
>
> - è¶Šé å‰ â†’ è¶Šé€æ˜
> - è¶Šé å‰ â†’ è¶Šç»†ï¼ˆå¯é€‰ï¼‰
> - èµ·ç‚¹é€çº§å‘ååç§»

ä¹Ÿå°±æ˜¯è¯´ï¼š

```
|====== ä¸»äº®æ®µ ======|
   |====|
      |==|
         |=|
```

------

# äºŒã€ä½ ç°åœ¨å·²æœ‰çš„â€œå•äº®æ®µâ€å›é¡¾

ä½ ç°åœ¨åœ¨ `_onPostRender` é‡Œåªæœ‰ **ä¸€æ®µ**ï¼š

```js
const start = (time / speed) % length;
const end = start + length * flowRatio;

this._drawFlowSegment(ctx, geom, start, end);
```

è¿™åªèƒ½ç”» **ä¸€æ¡äº®çº¿**ï¼Œæ‰€ä»¥æ²¡æœ‰å°¾è¿¹ã€‚

------

# ä¸‰ã€åŠ å°¾è¿¹ï¼Œåªæ”¹ 2 ä¸ªåœ°æ–¹

------

## â‘  å¢åŠ â€œå°¾è¿¹å‚æ•°â€ï¼ˆå»ºè®®åŠ åˆ° optionsï¼‰

```js
this.options = {
  speed: 90,
  flowRatio: 0.18,
  trailCount: 6,        // å°¾è¿¹æ®µæ•°ï¼ˆæ ¸å¿ƒï¼‰
  trailSpacing: 0.015, // æ¯æ®µä¹‹é—´çš„è·ç¦»æ¯”ä¾‹
  color: [255, 0, 0],  // æ”¹æˆ RGBï¼Œæ–¹ä¾¿ç®—é€æ˜åº¦
  flowWidth: 4
};
```

------

## â‘¡ æ”¹ `_onPostRender` â€”â€” ç”»â€œå¤šæ®µâ€

### âŒ åŸæ¥ï¼ˆå•æ®µï¼‰

```js
this._drawFlowSegment(ctx, geom, start, end);
```

### âœ… ç°åœ¨ï¼ˆå¤šæ®µå°¾è¿¹ï¼‰

```js
for (let i = 0; i < this.options.trailCount; i++) {
  const offset = i * length * this.options.trailSpacing;

  const s = start - offset;
  const e = end - offset;

  if (e <= 0) continue;

  const alpha = 1 - i / this.options.trailCount;
  const width = this.options.flowWidth * alpha;

  this._drawFlowSegment(ctx, geom, s, e, alpha, width);
}
```

ğŸ‘‰ **è¿™ä¸€å±‚ for å¾ªç¯ = å°¾è¿¹çš„æœ¬è´¨**

------

# å››ã€æ”¹ `_drawFlowSegment`ï¼Œæ”¯æŒé€æ˜åº¦ & çº¿å®½

### âŒ åŸæ¥

```js
ctx.strokeStyle = this.options.color;
ctx.lineWidth = this.options.flowWidth;
```

### âœ… æ”¹æˆ

```js
_drawFlowSegment(ctx, line, start, end, alpha = 1, width) {
  ...
  ctx.strokeStyle = `rgba(${this.options.color[0]},${this.options.color[1]},${this.options.color[2]},${alpha})`;
  ctx.lineWidth = width;
  ctx.stroke();
}
```

âš ï¸ æ³¨æ„ï¼š

- `start / end` å…è®¸ä¸ºè´Ÿæ•°ï¼ˆè‡ªç„¶è£æ‰ï¼‰
- alpha è¶Šå°è¶Šâ€œæ·¡â€

------

# äº”ã€æœ€ç»ˆæ•ˆæœä¼šå˜æˆä»€ä¹ˆæ ·ï¼Ÿ

ä½ ä¼šçœ‹åˆ°ï¼š

- ğŸ”´ æœ€å‰é¢ï¼š**äº®ã€ç²—ã€æ¸…æ™°**
- ğŸ”´ åé¢ï¼š**é€æ¸å˜ç»†ã€å˜æ·¡**
- ğŸ”´ çœ‹èµ·æ¥åƒâ€œèƒ½é‡åœ¨æµåŠ¨â€

ğŸ‘‰ **è¿™å°±æ˜¯ä½ æˆªå›¾é‡Œé‚£ç§â€œç”µæµå…‰å¸¦â€**

------

# å…­ã€å‡ ä¸ªå…³é”®å‚æ•°è°ƒä¼˜å»ºè®®ï¼ˆéå¸¸é‡è¦ï¼‰

### 1ï¸âƒ£ trailCountï¼ˆå°¾è¿¹é•¿åº¦ï¼‰

| æ•°å€¼ | æ•ˆæœ           |
| ---- | -------------- |
| 3~4  | çŸ­å°¾           |
| 6~8  | â­ æ¨è         |
| 10+  | å¾ˆç‚«ï¼Œä½†åƒæ€§èƒ½ |

------

### 2ï¸âƒ£ trailSpacingï¼ˆå°¾è¿¹å¯†åº¦ï¼‰

```js
trailSpacing = 0.01 ~ 0.02
```

- å° â†’ å°¾è¿¹è¿ç»­
- å¤§ â†’ ä¸€èŠ‚ä¸€èŠ‚çš„

------

### 3ï¸âƒ£ speedï¼ˆæµé€Ÿï¼‰

> **å°¾è¿¹å­˜åœ¨æ—¶ï¼Œå»ºè®®ç¨å¾®æ”¾æ…¢é€Ÿåº¦**

```js
speed: 100 ~ 120
```

------

# ä¸ƒã€æ€§èƒ½è¯´æ˜ï¼ˆä½ å¯ä»¥æ”¾å¿ƒï¼‰

- æ¯æ¡çº¿ï¼š`trailCount Ã— drawFlowSegment`
- 20 æ¡çº¿ Ã— 6 æ®µ = 120 æ¬¡ canvas path
- **å®Œå…¨ OK**

å¦‚æœå°†æ¥ä¸Šç™¾æ¡çº¿ï¼š

- é™ä½ `trailCount`
- æˆ–åªç»™â€œé€‰ä¸­ / ä¸»å¹²çº¿â€å¼€å°¾è¿¹

------

# å…«ã€å†â€œè¿›ä¸€é˜¶â€ï¼ˆå¯é€‰ï¼‰

æˆ‘å¯ä»¥ç»§ç»­å¸®ä½ åšï¼š

- âœ¨ **å°¾è¿¹æ¸å˜è‰²ï¼ˆé»„ â†’ çº¢ï¼‰**
- âœ¨ **æŒ‡æ•°è¡°å‡ï¼ˆæ›´çœŸå®ï¼‰**
- âœ¨ **è„‰å†²å¼æµåŠ¨ï¼ˆä¸€æ³¢ä¸€æ³¢ï¼‰**
- âœ¨ **å‘Šè­¦æ—¶åŠ é—ªçƒé¢‘ç‡**

# ç±»å®Œæ•´ä»£ç 

```ts
// CableFlowLayer.js
// OpenLayers 6+
// ç”¨æ³•ï¼šnew CableFlowLayer(map, options).start();

import VectorLayer from 'ol/layer/Vector';
import VectorSource from 'ol/source/Vector';
import Feature from 'ol/Feature';
import LineString from 'ol/geom/LineString';
import { Style, Stroke } from 'ol/style';
import { fromLonLat } from 'ol/proj';

export default class CableFlowLayer {
  constructor(map, options = {}) {
    this.map = map;

    this.options = {
      stationCoord: options.stationCoord,   // [lon, lat]
      cables: options.cables || [],          // åç«¯ gisType=2 æ•°æ®
      speed: options.speed ?? 100,
      flowRatio: options.flowRatio ?? 0.18,
      trailCount: options.trailCount ?? 6,
      trailSpacing: options.trailSpacing ?? 0.015,
      baseColor: options.baseColor ?? 'rgba(255,0,0,0.35)',
      flowColor: options.flowColor ?? [255, 0, 0], // RGB
      baseWidth: options.baseWidth ?? 2,
      flowWidth: options.flowWidth ?? 4
    };

    this.station = fromLonLat(this.options.stationCoord);
    this._running = false;
    this._postRender = this._onPostRender.bind(this);

    this._initLayers();
    this._initFeatures();
  }

  _initLayers() {
    this.source = new VectorSource();

    this.baseLayer = new VectorLayer({
      source: this.source,
      style: new Style({
        stroke: new Stroke({
          color: this.options.baseColor,
          width: this.options.baseWidth
        })
      })
    });

    this.flowLayer = new VectorLayer({
      source: this.source,
      renderMode: 'image'
    });

    this.map.addLayer(this.baseLayer);
    this.map.addLayer(this.flowLayer);
  }

  _initFeatures() {
    this.options.cables.forEach(item => {
      if (!item.points || item.points.length < 2) return;

      let coords = item.points.map(p =>
        fromLonLat([p.longitude, p.latitude])
      );

      // æ–¹å‘ç»Ÿä¸€ï¼šé£æœº â†’ é›†ç”µç«™
      if (this._distance(coords[coords.length - 1], this.station) >
          this._distance(coords[0], this.station)) {
        coords.reverse();
      }

      this.source.addFeature(
        new Feature({
          geometry: new LineString(coords)
        })
      );
    });
  }

  start() {
    if (this._running) return;
    this._running = true;
    this.flowLayer.on('postrender', this._postRender);
    this.map.render();
  }

  stop() {
    this._running = false;
    this.flowLayer.un('postrender', this._postRender);
  }

  destroy() {
    this.stop();
    this.map.removeLayer(this.baseLayer);
    this.map.removeLayer(this.flowLayer);
    this.source.clear();
  }

  _onPostRender(e) {
    if (!this._running) return;

    const ctx = e.context;
    const time = e.frameState.time;

    ctx.save();
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    this.source.forEachFeature(feature => {
      const geom = feature.getGeometry();
      const length = geom.getLength();

      const baseStart = (time / this.options.speed) % length;
      const baseEnd = baseStart + length * this.options.flowRatio;

      for (let i = 0; i < this.options.trailCount; i++) {
        const offset = i * length * this.options.trailSpacing;
        const start = baseStart - offset;
        const end = baseEnd - offset;

        if (end <= 0) continue;

        const alpha = 1 - i / this.options.trailCount;
        const width = this.options.flowWidth * alpha;

        this._drawFlowSegment(ctx, geom, start, end, alpha, width);
      }
    });

    ctx.restore();
    this.map.render();
  }

  _drawFlowSegment(ctx, line, start, end, alpha, width) {
    const coords = line.getCoordinates();
    let acc = 0;
    let started = false;

    ctx.beginPath();

    for (let i = 0; i < coords.length - 1; i++) {
      const a = coords[i];
      const b = coords[i + 1];
      const seg = Math.hypot(b[0] - a[0], b[1] - a[1]);

      const segStart = acc;
      const segEnd = acc + seg;

      if (segEnd < start) {
        acc += seg;
        continue;
      }
      if (segStart > end) break;

      const s = Math.max(0, (start - segStart) / seg);
      const e = Math.min(1, (end - segStart) / seg);

      const x1 = a[0] + (b[0] - a[0]) * s;
      const y1 = a[1] + (b[1] - a[1]) * s;
      const x2 = a[0] + (b[0] - a[0]) * e;
      const y2 = a[1] + (b[1] - a[1]) * e;

      const p1 = this.map.getPixelFromCoordinate([x1, y1]);
      const p2 = this.map.getPixelFromCoordinate([x2, y2]);

      if (!started) {
        ctx.moveTo(p1[0], p1[1]);
        started = true;
      }
      ctx.lineTo(p2[0], p2[1]);

      acc += seg;
    }

    const [r, g, b] = this.options.flowColor;
    ctx.strokeStyle = `rgba(${r},${g},${b},${alpha})`;
    ctx.lineWidth = width;
    ctx.stroke();
  }

  _distance(a, b) {
    const dx = a[0] - b[0];
    const dy = a[1] - b[1];
    return Math.sqrt(dx * dx + dy * dy);
  }
}

```



# ä½¿ç”¨hookå®ç°(éæ¸å˜è‰²)

```vue
<!-- CableMap.vue -->
<template>
  <div class="map-container" ref="mapRef"></div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import Map from 'ol/Map';
import View from 'ol/View';
import TileLayer from 'ol/layer/Tile';
import XYZ from 'ol/source/XYZ';
import 'ol/ol.css';

/* ===== å¼•å…¥ä½ åˆšæ‰å®ç°çš„ hook ===== */
import { useCableFlow } from './useCableFlow';

/* ===== DOM ===== */
const mapRef = ref<HTMLDivElement | null>(null);

/* ===== æ¨¡æ‹Ÿæ¥å£ ===== */
function mockFetchCableData(): Promise<any[]> {
  return new Promise(resolve => {
    setTimeout(() => {
      const list: any[] = [];

      // æ¨¡æ‹Ÿ 20 ä¸ªé›†ç”µç«™ï¼Œæ¯ä¸ª 15 æ¡æµ·ç¼†
      for (let s = 0; s < 20; s++) {
        const stationLng = 111.3 + Math.random() * 0.6;
        const stationLat = 20.7 + Math.random() * 0.6;

        // é›†ç”µç«™ï¼ˆç‚¹ï¼‰
        list.push({
          gisType: 1,
          entityId: `station-${s}`,
          points: [{ longitude: stationLng, latitude: stationLat }],
          style: '{}'
        });

        // æµ·ç¼†ï¼ˆçº¿ï¼‰
        for (let i = 0; i < 15; i++) {
          list.push({
            gisType: 2,
            entityId: `cable-${s}-${i}`,
            points: [
              {
                longitude: stationLng,
                latitude: stationLat
              },
              {
                longitude: stationLng + (Math.random() - 0.5) * 0.2,
                latitude: stationLat + (Math.random() - 0.5) * 0.2
              }
            ],
            style: JSON.stringify({
              lineWidth: 3,
              speed: 100 + Math.random() * 80,
              trail: 6,
              flowStartColor: 'rgba(255,30,2,0)',
              flowEndColor: '#ffffff'
            })
          });
        }
      }

      resolve(list);
    }, 800); // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
  });
}

/* ===== åˆå§‹åŒ–åœ°å›¾ ===== */
onMounted(async () => {
  const map = new Map({
    target: mapRef.value!,
    layers: [
      new TileLayer({
        source: new XYZ({
          url: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png'
        })
      })
    ],
    view: new View({
      center: [111.6, 20.9],
      projection: 'EPSG:4326',
      zoom: 10,
      minZoom: 5,
      maxZoom: 18
    })
  });

  /* ===== è·å–æ¥å£æ•°æ® ===== */
  const data = await mockFetchCableData();

  /* ===== å¯åŠ¨æµåŠ¨æµ·ç¼†ç³»ç»Ÿ ===== */
  useCableFlow(map, {
    data,
    minZoom: 13
  });
});
</script>

<style scoped>
.map-container {
  width: 100%;
  height: 100vh;
}
</style>

```

hook:

```ts
/* =========================================================
   Vue 3 + OpenLayers
   useCableFlow composable + Map ç»„ä»¶ï¼ˆé«˜æ€§èƒ½ç‰ˆæœ¬ï¼‰
   è¯´æ˜ï¼š
   - æ”¯æŒ 300+ ç”µç¼†æ•°æ®
   - å¤šé›†ç”µç«™ã€å¤šç”µç¼†
   - Canvas æ¸éšæµåŠ¨å…‰å¸¦
   - zoom >= 13 æ‰æ¸²æŸ“ï¼Œä½äºéšè—
   ========================================================= */

/* =========================
   useCableFlow.js
   ========================= */
import { onUnmounted } from 'vue';
import VectorLayer from 'ol/layer/Vector';
import VectorSource from 'ol/source/Vector';
import Feature from 'ol/Feature';
import LineString from 'ol/geom/LineString';
import Point from 'ol/geom/Point';
import { Style, Stroke, Icon } from 'ol/style';
import { fromLonLat } from 'ol/proj';

export function useCableFlow(map, options) {
  const {
    data,                // æ¥å£è¿”å›æ•°ç»„ï¼ˆ300+ï¼‰
    minZoom = 13,
    speed = 110,
    flowRatio = 0.15,
    trailCount = 5,
    trailSpacing = 0.015
  } = options;

  /* ---------- Source ---------- */
  const cableSource = new VectorSource();
  const stationSource = new VectorSource();

  /* ---------- Layers ---------- */
  const cableBaseLayer = new VectorLayer({
    source: cableSource,
    style: f => new Style({
      stroke: new Stroke({
        color: f.get('baseColor'),
        width: f.get('lineWidth')
      })
    }),
    visible: false
  });

  const cableFlowLayer = new VectorLayer({
    source: cableSource,
    renderMode: 'image',
    visible: false
  });

  const stationLayer = new VectorLayer({
    source: stationSource,
    style: new Style({
      image: new Icon({
        src: '/station.png',
        scale: 0.7,
        anchor: [0.5, 1]
      })
    }),
    visible: false
  });

  map.addLayer(cableBaseLayer);
  map.addLayer(cableFlowLayer);
  map.addLayer(stationLayer);

  /* ---------- æ•°æ®é¢„å¤„ç†ï¼ˆä¸€æ¬¡æ€§ï¼‰ ---------- */
  const stationMap = new Map(); // key: gisCluster / projectId

  data.forEach(item => {
    if (item.gisType === 1) {
      const coord = fromLonLat([
        item.points[0].longitude,
        item.points[0].latitude
      ]);
      stationMap.set(item.entityId, coord);
      stationSource.addFeature(
        new Feature({ geometry: new Point(coord) })
      );
    }
  });

  data.forEach(item => {
    if (item.gisType !== 2 || !item.points?.length) return;

    const coords = item.points.map(p =>
      fromLonLat([p.longitude, p.latitude])
    );

    const styleCfg = JSON.parse(item.style || '{}');
    const color = styleCfg.imageUrl || '#ff1e02';

    const feature = new Feature({
      geometry: new LineString(coords),
      baseColor: `${color}55`,
      flowColor: hexToRgb(color),
      lineWidth: styleCfg.lineWidth || 2
    });

    cableSource.addFeature(feature);
  });

  /* ---------- åŠ¨ç”» ---------- */
  let running = true;

  cableFlowLayer.on('postrender', e => {
    if (!running || !cableFlowLayer.getVisible()) return;

    const ctx = e.context;
    const time = e.frameState.time;

    ctx.save();
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    cableSource.forEachFeature(feature => {
      const geom = feature.getGeometry();
      const length = geom.getLength();
      const baseStart = (time / speed) % length;
      const baseEnd = baseStart + length * flowRatio;

      for (let i = 0; i < trailCount; i++) {
        const offset = i * length * trailSpacing;
        const start = baseStart - offset;
        const end = baseEnd - offset;
        if (end <= 0) continue;

        const alpha = 1 - i / trailCount;
        drawSegment(
          ctx,
          map,
          geom,
          start,
          end,
          feature.get('flowColor'),
          alpha,
          feature.get('lineWidth') * 2 * alpha
        );
      }
    });

    ctx.restore();
    map.render();
  });

  /* ---------- zoom æ§åˆ¶ ---------- */
  const view = map.getView();
  const onZoomChange = () => {
    const z = view.getZoom();
    const visible = z >= minZoom;
    cableBaseLayer.setVisible(visible);
    cableFlowLayer.setVisible(visible);
    stationLayer.setVisible(visible);
  };

  view.on('change:resolution', onZoomChange);
  onZoomChange();

  onUnmounted(() => {
    running = false;
    map.removeLayer(cableBaseLayer);
    map.removeLayer(cableFlowLayer);
    map.removeLayer(stationLayer);
    view.un('change:resolution', onZoomChange);
  });
}

/* ---------- utils ---------- */
function drawSegment(ctx, map, line, start, end, color, alpha, width) {
  const coords = line.getCoordinates();
  let acc = 0;
  let started = false;

  ctx.beginPath();

  for (let i = 0; i < coords.length - 1; i++) {
    const a = coords[i];
    const b = coords[i + 1];
    const seg = Math.hypot(b[0] - a[0], b[1] - a[1]);

    const segStart = acc;
    const segEnd = acc + seg;

    if (segEnd < start) {
      acc += seg;
      continue;
    }
    if (segStart > end) break;

    const s = Math.max(0, (start - segStart) / seg);
    const e = Math.min(1, (end - segStart) / seg);

    const x1 = a[0] + (b[0] - a[0]) * s;
    const y1 = a[1] + (b[1] - a[1]) * s;
    const x2 = a[0] + (b[0] - a[0]) * e;
    const y2 = a[1] + (b[1] - a[1]) * e;

    const p1 = map.getPixelFromCoordinate([x1, y1]);
    const p2 = map.getPixelFromCoordinate([x2, y2]);

    if (!started) {
      ctx.moveTo(p1[0], p1[1]);
      started = true;
    }
    ctx.lineTo(p2[0], p2[1]);

    acc += seg;
  }

  ctx.strokeStyle = `rgba(${color[0]},${color[1]},${color[2]},${alpha})`;
  ctx.lineWidth = width;
  ctx.stroke();
}

function hexToRgb(hex) {
  const c = hex.replace('#', '');
  return [
    parseInt(c.substring(0, 2), 16),
    parseInt(c.substring(2, 4), 16),
    parseInt(c.substring(4, 6), 16)
  ];
}

/* =========================
   MapView.vue
   ========================= */
<template>
  <div ref="mapEl" class="map"></div>
</template>

<script setup>
import { onMounted, ref } from 'vue';
import Map from 'ol/Map';
import View from 'ol/View';
import TileLayer from 'ol/layer/Tile';
import OSM from 'ol/source/OSM';
import { useCableFlow } from './useCableFlow';

const mapEl = ref();

onMounted(async () => {
  const map = new Map({
    target: mapEl.value,
    layers: [new TileLayer({ source: new OSM() })],
    view: new View({
      center: [12400000, 2500000],
      zoom: 8
    })
  });

  const res = await fetch('/api/gis');
  const data = await res.json();

  useCableFlow(map, {
    data,
    minZoom: 13
  });
});
</script>

<style>
.map {
  width: 100%;
  height: 100%;
}
</style>

```

## ä¸ºä»€ä¹ˆè¿™ä¸ª Vue ç”¨æ³•æ˜¯â€œæ­£ç¡®å§¿åŠ¿â€

1. **ç»„ä»¶åªå…³å¿ƒä¸‰ä»¶äº‹**
   - åœ°å›¾å®¹å™¨
   - æ•°æ®è·å–
   - å¯åŠ¨ hook
2. **æ‰€æœ‰ GIS / åŠ¨ç”»å¤æ‚åº¦è¢«å°è£…**
   - ç»„ä»¶ä¸å…³å¿ƒ Canvas
   - ä¸å…³å¿ƒ postrender
   - ä¸å…³å¿ƒæ€§èƒ½ç­–ç•¥
3. **éå¸¸é€‚åˆçœŸå®é¡¹ç›®**
   - æ¥å£æ¢æˆçœŸå® APIï¼Œå…¶ä»–ä¸ç”¨åŠ¨
   - æ”¯æŒå¤šä¸ªé¡µé¢å¤ç”¨
   - ä¸æ±¡æŸ“ Vue å“åº”å¼ç³»ç»Ÿ

ä¸‹é¢æˆ‘**æŒ‰â€œä»æ•´ä½“åˆ°ç»†èŠ‚ã€ä»ä¸šåŠ¡åˆ°å®ç°â€çš„é¡ºåº**ï¼Œç³»ç»Ÿæ€§è§£é‡Šè¿™ä»½ä»£ç ã€‚ä¸ä¼šæ‹†æˆé›¶ç¢ç‚¹ï¼Œé‡ç‚¹æ”¾åœ¨ä½ æœ€å…³å¿ƒçš„ **æ€§èƒ½ã€æµåŠ¨æœºåˆ¶ã€å¾ªç¯ä½ç½®ã€ç¼©æ”¾æ§åˆ¶** ä¸Šã€‚

------

## ä¸€ã€æ•´ä½“æ¶æ„ï¼ˆå…ˆå»ºç«‹å…¨å±€è®¤çŸ¥ï¼‰

è¿™å¥—å®ç°å¯ä»¥æ‹†æˆ **å››ä¸ªå±‚çº§**ï¼š

1. **ä¸šåŠ¡æ•°æ®å±‚**
   - æ¥å£è¿”å› 300+ æ¡ GIS æ•°æ®
   - åŒ…å«é›†ç”µç«™ï¼ˆç‚¹ï¼‰å’Œæµ·ç¼†ï¼ˆçº¿ï¼‰
   - æ¯æ¡çº¿éƒ½æœ‰ç‹¬ç«‹æ ·å¼é…ç½®ï¼ˆé¢œè‰²ã€å®½åº¦ã€æµåŠ¨æ–¹å¼ï¼‰
2. **å›¾å±‚ç»“æ„å±‚ï¼ˆOpenLayersï¼‰**
   - `stationLayer`ï¼šé›†ç”µç«™ç‚¹ä½
   - `cableBaseLayer`ï¼šé™æ€æµ·ç¼†åº•çº¿ï¼ˆåŠé€æ˜ï¼‰
   - `cableFlowLayer`ï¼šæµåŠ¨å…‰å¸¦ï¼ˆCanvas åŠ¨ç”»ï¼‰
3. **åŠ¨ç”»é©±åŠ¨å±‚**
   - åˆ©ç”¨ `postrender` é’©å­
   - åŸºäº `time` + `map.render()` å½¢æˆå¸§å¾ªç¯
   - ä¸ä½¿ç”¨ `setInterval` / `requestAnimationFrame`
4. **Vue ç»„åˆå¼å°è£…**
   - `useCableFlow(map, options)`
   - å®Œå…¨è§£è€¦ä¸šåŠ¡ç»„ä»¶
   - è‡ªåŠ¨å¤„ç†é”€æ¯ã€ç¼©æ”¾ã€æ€§èƒ½å¼€å…³

------

## äºŒã€ä¸ºä»€ä¹ˆè¦æ‹†æˆ 3 ä¸ªå›¾å±‚ï¼ˆéå¸¸å…³é”®ï¼‰

### 1ï¸âƒ£ cableBaseLayerï¼ˆé™æ€åº•çº¿ï¼‰

```js
new VectorLayer({
  source: cableSource,
  style: f => new Style({
    stroke: new Stroke({
      color: f.get('baseColor'),
      width: f.get('lineWidth')
    })
  })
})
```

ä½œç”¨ï¼š

- æä¾›**ç¨³å®šçš„çº¿å½¢ç»“æ„**
- é¿å…æµåŠ¨å±‚ä¸ç»˜åˆ¶æ—¶â€œçº¿æ¶ˆå¤±â€
- åŠé€æ˜ï¼Œå¢å¼ºå±‚æ¬¡æ„Ÿ

> åŸåˆ™ï¼š**é™æ€çš„äº¤ç»™ GPUï¼ŒåŠ¨æ€çš„äº¤ç»™ Canvas**

------

### 2ï¸âƒ£ cableFlowLayerï¼ˆæµåŠ¨å…‰å¸¦æ ¸å¿ƒï¼‰

```js
new VectorLayer({
  source: cableSource,
  renderMode: 'image'
})
```

é‡ç‚¹ï¼š

- ä¸ä½¿ç”¨ `style`
- å®Œå…¨ä¾èµ– `postrender`
- OpenLayers ä¼šç»™ä½ ä¸€ä¸ª **Canvas Context**

è¿™å±‚æ˜¯**æ€§èƒ½å…³é”®ç‚¹**ï¼š

- æ‰€æœ‰æµåŠ¨æ•ˆæœåªç”»â€œå±€éƒ¨çº¿æ®µâ€
- ä¸é‡å»º Feature
- ä¸ä¿®æ”¹ Geometry

------

### 3ï¸âƒ£ stationLayerï¼ˆé›†ç”µç«™ï¼‰

æ™®é€šç‚¹ä½å›¾å±‚ï¼Œåªåœ¨é«˜ zoom æ˜¾ç¤ºï¼Œé¿å…ä½ zoom å †å ã€‚

------

## ä¸‰ã€æ•°æ®ä¸ºä»€ä¹ˆåªå¤„ç†ä¸€æ¬¡ï¼ˆæ€§èƒ½å…³é”®ï¼‰

### ç‚¹ä½é¢„å¤„ç†

```js
stationMap.set(item.entityId, coord);
stationSource.addFeature(new Feature({
  geometry: new Point(coord)
}));
```

### çº¿æ•°æ®é¢„å¤„ç†

```js
const feature = new Feature({
  geometry: new LineString(coords),
  baseColor,
  flowColor,
  lineWidth
});
```

å…³é”®ç‚¹ï¼š

- **æ¥å£æ•°æ® â†’ Featureï¼Œåªåšä¸€æ¬¡**
- style ä¸­çš„ JSON **åª parse ä¸€æ¬¡**
- æµåŠ¨åªä¾èµ– feature ä¸Šçš„å±æ€§

> è¿™å°±æ˜¯ä½ èƒ½æ‰¿è½½ **å‡ åä¸ªé›†ç”µç«™ + 300 æ¡çº¿** çš„åŸå› 

------

## å››ã€çœŸæ­£â€œæµåŠ¨â€çš„æ ¸å¿ƒæœºåˆ¶ï¼ˆä½ åå¤é—®çš„åœ°æ–¹ï¼‰

### 1ï¸âƒ£ åŠ¨ç”»å…¥å£åœ¨å“ªé‡Œï¼Ÿ

```js
cableFlowLayer.on('postrender', e => {
  ...
  map.render();
});
```

è¿™å°±æ˜¯å¾ªç¯ã€‚

è§£é‡Šæ¸…æ¥šï¼š

- OpenLayers æ¯ä¸€å¸§éƒ½ä¼šè§¦å‘ `postrender`
- `map.render()` ä¼šè¯·æ±‚ä¸‹ä¸€å¸§
- å½¢æˆ **OpenLayers å†…éƒ¨åŠ¨ç”»å¾ªç¯**
- ä¸éœ€è¦ä½ æ‰‹åŠ¨å†™ `requestAnimationFrame`

âœ… **è¿™æ˜¯æœ€é«˜æ€§èƒ½ã€æœ€å¹²å‡€çš„åšæ³•**

------

### 2ï¸âƒ£ æ—¶é—´é©±åŠ¨ï¼ˆæµåŠ¨çš„æ ¹æºï¼‰

```js
const time = e.frameState.time;
const baseStart = (time / speed) % length;
```

å«ä¹‰ï¼š

- `time`ï¼šå½“å‰å¸§çš„æ¯«ç§’æ—¶é—´æˆ³
- `/ speed`ï¼šæ§åˆ¶æµé€Ÿ
- `% length`ï¼šè®©æµåŠ¨åœ¨æ•´æ¡çº¿å¾ªç¯

**è¿™è¡Œä»£ç  = ç”µæµåœ¨â€œå¾€å‰è·‘â€**

------

## äº”ã€æ¸éšå°¾è¿¹æ˜¯å¦‚ä½•å®ç°çš„

### 1ï¸âƒ£ å¤šæ®µå åŠ ï¼Œè€Œä¸æ˜¯æ¸å˜ stroke

```js
for (let i = 0; i < trailCount; i++) {
  const offset = i * length * trailSpacing;
  const alpha = 1 - i / trailCount;
}
```

åŸç†ï¼š

- åŒä¸€æ¡çº¿
- ç”» **å¤šæ®µç¨å¾®å¾€åçš„æµåŠ¨çº¿**
- æ¯ä¸€æ®µé€æ˜åº¦æ›´ä½ã€çº¿æ›´ç»†

æ•ˆæœä¸Šå°±æ˜¯ï¼š

```
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–’â–’â–’â–‘â–‘â–‘
```

è€Œä¸æ˜¯ä¸€æ¡ç”Ÿç¡¬çš„çº¿ã€‚

------

### 2ï¸âƒ£ drawSegment åªç”»â€œéœ€è¦æµåŠ¨çš„é‚£ä¸€æ®µâ€

```js
drawSegment(ctx, map, geom, start, end, ...)
```

è¿™ä¸ªå‡½æ•°åšäº†ä¸‰ä»¶äº‹ï¼š

1. æ²¿ LineString ç´¯åŠ é•¿åº¦
2. åˆ¤æ–­å½“å‰ segment æ˜¯å¦è½åœ¨ `[start, end]`
3. åªæŠŠè¿™éƒ¨åˆ†è½¬æˆåƒç´ ç”»å‡ºæ¥

âœ… **æ²¡æœ‰æ•´çº¿ redraw**
âœ… **å¤æ‚çº¿æ®µä¹Ÿèƒ½è·‘å¾—åŠ¨**

------

## å…­ã€ä¸ºä»€ä¹ˆä¸ç”¨ Shader / WebGLï¼Ÿ

ä½ çš„ä¸šåŠ¡åœºæ™¯ï¼š

- GIS çº¿æ¡ä¸è§„åˆ™
- æ•°æ®é‡ä¸­ç­‰ï¼ˆ300ï½500ï¼‰
- æ ·å¼å¯é…ç½®

Canvas çš„ä¼˜åŠ¿ï¼š

- æ˜“æ§åˆ¶
- æ˜“ debug
- è¶³å¤Ÿé«˜æ€§èƒ½
- ä¸ OpenLayers åŸç”Ÿèåˆæœ€å¥½

WebGL åè€Œå¤æ‚ä¸”ç»´æŠ¤æˆæœ¬é«˜ã€‚

------

## ä¸ƒã€zoom >= 13 æ‰æ˜¾ç¤ºï¼Œå¦‚ä½•é¿å…æ€§èƒ½æµªè´¹

```js
const onZoomChange = () => {
  const visible = view.getZoom() >= minZoom;
  cableBaseLayer.setVisible(visible);
  cableFlowLayer.setVisible(visible);
  stationLayer.setVisible(visible);
};
```

å…³é”®ç‚¹ï¼š

- **ä¸æ˜¯ä¸ç”»**
- è€Œæ˜¯ **å›¾å±‚ç›´æ¥ invisible**
- invisible çš„ layerï¼š
  - ä¸è¿› render pipeline
  - `postrender` ç›´æ¥è·³è¿‡

è¿™æ˜¯æœ€å½»åº•çš„æ€§èƒ½å¼€å…³ã€‚

------

## å…«ã€Vue composable çš„ä»·å€¼

### ä¸ºä»€ä¹ˆä¸ç”¨å†™åœ¨ç»„ä»¶é‡Œï¼Ÿ

`useCableFlow` çš„å¥½å¤„ï¼š

- åœ°å›¾é€»è¾‘å’Œ UI è§£è€¦
- å¯å¤ç”¨ï¼ˆå¤šä¸ªåœ°å›¾ã€å¤šä¸ªé¡µé¢ï¼‰
- ç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨ç®¡ç†

```js
onUnmounted(() => {
  running = false;
  map.removeLayer(...)
});
```

ä½ ä¸ç”¨æ‹…å¿ƒï¼š

- é¡µé¢åˆ‡æ¢
- åœ°å›¾é”€æ¯
- å†…å­˜æ³„æ¼

------

## ä¹ã€æ€»ç»“ä¸€å¥è¯

> è¿™å¥—æ–¹æ¡ˆçš„æœ¬è´¨æ˜¯ï¼š
> **â€œé™æ€å‡ ä½•ä¸€æ¬¡æ€§æ„å»º + Canvas å±€éƒ¨æµåŠ¨ç»˜åˆ¶ + OpenLayers å†…éƒ¨æ¸²æŸ“å¾ªç¯ + zoom çº§åˆ«ç¡¬å¼€å…³â€**

å®ƒéå¸¸é€‚åˆä½ ç°åœ¨çš„ï¼š

- é›†ç”µç«™
- æµ·ç¼†
- ç”µæµæ–¹å‘
- å¤šæ•°æ®é‡
- å·¥ä¸š GIS åœºæ™¯

# ä½¿ç”¨hookå®ç°(æ¸å˜è‰²ç‰ˆ)

å¥½ï¼Œè¿™ä¸ªéœ€æ±‚éå¸¸æ˜ç¡®ï¼Œè€Œä¸”**ä¸éœ€è¦æ¨ç¿»ç°æœ‰ç»“æ„**ï¼Œåªæ˜¯åœ¨â€œæµåŠ¨ç»˜åˆ¶å±‚â€é‡Œåšä¸€æ¬¡**èƒ½åŠ›å‡çº§**å³å¯ã€‚
æˆ‘ç›´æ¥ç«™åœ¨ä½ ç°åœ¨è¿™å¥—å®ç°ä¹‹ä¸Šè§£é‡Šï¼š**å¦‚ä½•åšåˆ°â€œå¯é…ç½®çš„æ¸å˜æµåŠ¨é¢œè‰²â€**ï¼Œä»¥åŠå®ƒåœ¨ä»£ç ä¸­**å…·ä½“è½åœ¨å“ªä¸€å±‚ã€å“ªå‡ è¡Œ**ã€‚

------

## ä¸€ã€å…ˆç»™ç»“è®ºï¼ˆä½ å¿ƒé‡Œå…ˆæœ‰åº•ï¼‰

ä½ ç°åœ¨çš„æµåŠ¨æ•ˆæœæœ¬è´¨æ˜¯ï¼š

> **Canvas ç”»çº¿ + strokeStyle + å¤šæ®µå åŠ ï¼ˆå°¾è¿¹ï¼‰**

è¦æ”¯æŒ **è‡ªå®šä¹‰æ¸å˜é¢œè‰²**ï¼Œæ­£ç¡®åšæ³•æ˜¯ï¼š

> **åœ¨ `postrender` ä¸­ï¼Œä¸ºâ€œæ¯ä¸€å¸§çš„æµåŠ¨æ®µâ€åŠ¨æ€åˆ›å»º `CanvasLinearGradient`ï¼Œå¹¶æ›¿æ¢åŸæ¥çš„çº¯è‰² `strokeStyle`**

**ä¸æ˜¯ OpenLayers styleï¼Œä¸æ˜¯ CSSï¼Œä¸æ˜¯ WebGLã€‚**

------

## äºŒã€æ¸å˜é¢œè‰²åº”è¯¥é…ç½®åœ¨å“ªé‡Œï¼ˆä¸šåŠ¡å±‚ï¼‰

ä½ ç°åœ¨æ¥å£é‡Œå·²ç»æœ‰ï¼š

```json
"style": "{\"flowStyle\":\"start\",\"lineWidth\":3,\"lineStyle\":\"solid\",\"imageUrl\":\"#ff1e02\"}"
```

æˆ‘ä»¬åªéœ€è¦æ‰©å±•å®ƒï¼Œä¾‹å¦‚ï¼š

```json
"style": {
  "lineWidth": 3,
  "flow": {
    "speed": 120,
    "trail": 6,
    "gradient": [
      { "offset": 0, "color": "rgba(255,30,2,0)" },
      { "offset": 0.3, "color": "rgba(255,30,2,0.6)" },
      { "offset": 0.7, "color": "rgba(255,30,2,1)" },
      { "offset": 1, "color": "rgba(255,255,255,1)" }
    ]
  }
}
```

**è¿™å°±æ˜¯ä½ å¯¹äº§å“ã€é…ç½®ã€æ¥å£æœ€å‹å¥½çš„æ–¹å¼**ï¼š

- ä¸å†™æ­»é¢œè‰²
- å‰ç«¯åªâ€œè§£é‡Šâ€
- åæœŸå¯ä»¥åš UI é…ç½®

------

## ä¸‰ã€Feature ä¸Šå¦‚ä½•å­˜ï¼ˆåªåšä¸€æ¬¡ï¼Œæ€§èƒ½å…³é”®ï¼‰

åœ¨åˆ›å»º `LineString Feature` æ—¶ï¼š

```js
const flowGradient = style.flow?.gradient || null;

feature.setProperties({
  lineWidth: style.lineWidth || 3,
  flowSpeed: style.flow?.speed || 120,
  trailCount: style.flow?.trail || 6,
  flowGradient
});
```

æ³¨æ„ä¸¤ç‚¹ï¼š

1. **gradient åªå­˜ JSONï¼Œä¸ç”Ÿæˆ Canvas å¯¹è±¡**
2. Feature å±æ€§æ˜¯åªè¯»æ•°æ®ï¼Œä¸å‚ä¸åŠ¨ç”»

------

## å››ã€çœŸæ­£çš„å…³é”®ï¼šæ¸å˜æ˜¯åœ¨å“ªé‡Œâ€œç”Ÿæ•ˆâ€çš„ï¼Ÿ

### ğŸ“å”¯ä¸€æ­£ç¡®çš„ä½ç½®ï¼š`postrender` â†’ Canvas Context

åŸæ¥ä½ æ˜¯è¿™æ ·ç”»çš„ï¼ˆçº¯è‰²ï¼‰ï¼š

```js
ctx.strokeStyle = flowColor;
ctx.stroke();
```

ç°åœ¨è¦å˜æˆï¼š

```js
const gradient = ctx.createLinearGradient(x1, y1, x2, y2);
gradientStops.forEach(s => {
  gradient.addColorStop(s.offset, s.color);
});
ctx.strokeStyle = gradient;
ctx.stroke();
```

**è¿™ä¸€æ­¥å‘ç”Ÿåœ¨ï¼š**

> `_drawFlowSegment()`
> ä¹Ÿå°±æ˜¯â€œåªç”»å½“å‰å¸§æµåŠ¨çº¿æ®µâ€çš„åœ°æ–¹

------

## äº”ã€ä¸ºä»€ä¹ˆæ¸å˜å¿…é¡»â€œæ¯ä¸€å¸§é‡æ–°ç®—â€ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ªå¾ˆå¤šäººä¼šè¸©å‘çš„ç‚¹ã€‚

### åŸå› åªæœ‰ä¸€ä¸ªï¼š

> **æ¸å˜æ˜¯åŸºäºâ€œå½“å‰å±å¹•åƒç´ æ–¹å‘â€çš„**

æ¯ä¸€å¸§ï¼š

- æµåŠ¨æ®µçš„èµ·ç‚¹ä¸åŒ
- åƒç´ åæ ‡ä¸åŒ
- çº¿æ–¹å‘ä¸åŒ

æ‰€ä»¥ä½ å¿…é¡»ï¼š

```js
const startPx = map.getPixelFromCoordinate(startCoord);
const endPx   = map.getPixelFromCoordinate(endCoord);
```

ç„¶åç”¨å®ƒæ¥åˆ›å»º gradientã€‚

âŒ ä¸èƒ½ç¼“å­˜ gradient
âŒ ä¸èƒ½æå‰ç®—
âŒ ä¸èƒ½ç”¨ style

------

## å…­ã€æ¸å˜ + å°¾è¿¹ï¼Œæ˜¯å¦‚ä½•ååŒå·¥ä½œçš„ï¼Ÿ

ä½ ç°åœ¨çš„å°¾è¿¹é€»è¾‘æ˜¯ï¼š

```js
for (let i = 0; i < trailCount; i++) {
  const alpha = 1 - i / trailCount;
}
```

**å‡çº§åçš„æ­£ç¡®é€»è¾‘æ˜¯ï¼š**

- æ¸å˜æ§åˆ¶â€œå‰åé¢œè‰²å˜åŒ–â€
- alpha æ§åˆ¶â€œå†å²å¸§è¡°å‡â€

ä¹Ÿå°±æ˜¯è¯´ï¼š

```js
ctx.globalAlpha = alpha;
ctx.strokeStyle = gradient;
ctx.stroke();
```

æ•ˆæœæ˜¯ï¼š

- å‰ç«¯äº®ï¼ˆæ¸å˜æœ€åä¸€ä¸ª stopï¼‰
- åç«¯æš—ï¼ˆæ¸å˜å‰å‡ ä¸ª stopï¼‰
- å°¾è¿¹è‡ªç„¶æ¶ˆå¤±

è¿™æ˜¯å·¥ä¸š GIS å¸¸è§çš„â€œç”µæµ / æ•°æ®æµâ€è§†è§‰æ¨¡å‹ã€‚

------

## ä¸ƒã€æ€§èƒ½ä¼šä¸ä¼šå˜å·®ï¼Ÿ

ç»“è®ºï¼š**ä¸ä¼šæ˜æ˜¾ä¸‹é™**ï¼ŒåŸå› å¦‚ä¸‹ï¼š

1. **gradient åªä½œç”¨åœ¨â€œæµåŠ¨æ®µâ€**
   - ä¸æ˜¯æ•´æ¡çº¿
   - é•¿åº¦å¯æ§ï¼ˆæ¯”å¦‚ 10%ï¼‰
2. **CanvasLinearGradient æ˜¯è½»é‡å¯¹è±¡**
   - åˆ›å»ºæˆæœ¬è¿œå°äº DOM / WebGL
3. **ä½ å·²ç»åšäº† zoom â‰¥ 13 æ‰æ¸²æŸ“**
   - ä½ zoom å®Œå…¨ä¸å‚ä¸åŠ¨ç”»

åœ¨ä½ è¿™ä¸ªé‡çº§ï¼ˆ300ï½500 æ¡çº¿ï¼‰ï¼š

> **CPU å ç”¨å¢åŠ  < 10%**

------

## å…«ã€å¦‚æœä½ æœªæ¥è¿˜æƒ³ç»§ç»­è¿›é˜¶

åœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼Œä½ å¯ä»¥éå¸¸è‡ªç„¶åœ°æ‰©å±•å‡ºï¼š

- ä¸åŒæ–¹å‘ï¼ˆstart â†’ end / end â†’ startï¼‰
- æ•…éšœæ®µçº¢è‰²é—ªçƒ
- ä¸åŒé›†ç”µç«™ä¸åŒæ¸å˜æ¨¡æ¿
- æµé€Ÿä¸å®æ—¶æ•°æ®ç»‘å®š

è€Œ**æ ¸å¿ƒç»˜åˆ¶é€»è¾‘ä¸€è¡Œä¸ç”¨æ¨ç¿»**ã€‚

------

## ä¹ã€ä¸€å¥è¯æ€»ç»“ï¼ˆå¸®ä½ è®°ä½ï¼‰

> **OpenLayers çš„æ¸å˜æµåŠ¨çº¿ = Canvas postrender + åŠ¨æ€ LinearGradient + æ—¶é—´é©±åŠ¨èµ·ç‚¹**



# åšæˆåªæä¾›èµ·å§‹å’Œç»“æŸçš„æ¸å˜è‰²ï¼Œå†…éƒ¨è‡ªå·±è®¡ç®—æ¸å˜è‰²

æ˜ç™½ï¼Œè¿™ä¸ªéœ€æ±‚å…¶å®**æ¯”â€œè‡ªå®šä¹‰å¤šæ®µæ¸å˜â€æ›´åˆç†**ï¼Œä¹Ÿæ›´ç¬¦åˆå·¥ç¨‹è½åœ°ï¼š
**æ¥å£åªç»™â€œèµ·å§‹è‰² + ç»“æŸè‰²â€ï¼Œå‰ç«¯è´Ÿè´£ç”Ÿæˆå®Œæ•´æ¸å˜ã€‚**

ä¸‹é¢æˆ‘ä» **è®¾è®¡åŸåˆ™ â†’ ä»£ç å±‚è½ç‚¹ â†’ ç®—æ³•ç»†èŠ‚ â†’ æ€§èƒ½å½±å“** å››ä¸ªå±‚æ¬¡ï¼ŒæŠŠè¿™ä»¶äº‹å½»åº•è®²æ¸…æ¥šã€‚

------

## ä¸€ã€è®¾è®¡åŸåˆ™ï¼ˆä¸ºä»€ä¹ˆè¿™æ ·åšæ˜¯å¯¹çš„ï¼‰

ä½ ç°åœ¨çš„ä¸šåŠ¡éå¸¸å…¸å‹ï¼š

- æµ·ç¼† / ç”µæµåªæœ‰â€œæ–¹å‘æ„Ÿâ€
- ä¸éœ€è¦äº§å“äººå‘˜ç†è§£ `colorStop`
- åæœŸåªæ”¹ä¸¤ä¸ªé¢œè‰²å°±èƒ½ç»Ÿä¸€é£æ ¼

æ‰€ä»¥æ­£ç¡®æŠ½è±¡åº”è¯¥æ˜¯ï¼š

```json
flow: {
  startColor: "#ff1e02",
  endColor: "#ffffff"
}
```

è€Œä¸æ˜¯ï¼š

```json
gradient: [{ offset: 0.12, color: ... }]
```

ğŸ‘‰ **æ¸å˜æ˜¯æ¸²æŸ“å®ç°ç»†èŠ‚ï¼Œä¸åº”è¯¥æš´éœ²ç»™æ¥å£**

------

## äºŒã€ä»£ç ç»“æ„ä¸Šï¼Œæ”¹åŠ¨å‘ç”Ÿåœ¨å“ªé‡Œï¼ˆæ ¸å¿ƒå®šä½ï¼‰

åªæ¶‰åŠ **ä¸€ä¸ªåœ°æ–¹**ï¼š

> **Canvas ç»˜åˆ¶æµåŠ¨æ®µæ—¶ï¼Œæ„é€  `LinearGradient` çš„é€»è¾‘**

ä¸å½±å“ï¼š

- æ•°æ®ç»“æ„
- Feature æ„å»º
- åŠ¨ç”»å¾ªç¯
- zoom æ§åˆ¶
- å°¾è¿¹æœºåˆ¶

è¿™æ˜¯ä¸€æ¬¡ **å±€éƒ¨å¢å¼ºï¼Œä¸æ˜¯é‡æ„**ã€‚

------

## ä¸‰ã€Feature ä¸Šåº”è¯¥å­˜ä»€ä¹ˆï¼ˆåªå­˜â€œåŸå§‹ä¿¡æ¯â€ï¼‰

åœ¨åˆ›å»ºæµ·ç¼† `Feature` æ—¶ï¼Œåªå­˜ï¼š

- `flowStartColor`
- `flowEndColor`
- `lineWidth`
- `trailCount`
- `speed`

ä¾‹å¦‚é€»è¾‘ä¸Šæ˜¯ï¼š

```js
feature.setProperties({
  flowStartColor: style.flow.startColor,
  flowEndColor: style.flow.endColor
});
```

âš ï¸ æ³¨æ„ï¼š
**ä¸è¦åœ¨è¿™é‡Œè®¡ç®—æ¸å˜ã€ä¸è¦ç”Ÿæˆ Canvas å¯¹è±¡**
Feature åªä¿å­˜â€œä¸šåŠ¡å±æ€§â€ã€‚

------

## å››ã€æ¸å˜è‰²æ˜¯å¦‚ä½•â€œè‡ªåŠ¨è®¡ç®—â€çš„ï¼ˆé‡ç‚¹ï¼‰

### 1ï¸âƒ£ æ¸å˜ä¸æ˜¯â€œç®— RGB æ•°ç»„â€

å¾ˆå¤šäººç¬¬ä¸€ååº”æ˜¯ï¼š

> â€œæˆ‘æ˜¯ä¸æ˜¯è¦æ‰‹åŠ¨æ’å€¼ç®— 10 ä¸ªé¢œè‰²ï¼Ÿâ€

**ä¸éœ€è¦ã€‚**

Canvas å·²ç»å¸®ä½ åšäº†æœ€ä¼˜è§£ã€‚

ä½ çœŸæ­£è¦åšçš„æ˜¯ï¼š

```js
const gradient = ctx.createLinearGradient(x1, y1, x2, y2);
gradient.addColorStop(0, startColor);
gradient.addColorStop(1, endColor);
```

**Canvas å†…éƒ¨ä¼šè‡ªåŠ¨ï¼š**

- å¤„ç† RGB / RGBA
- å¤„ç†é€æ˜åº¦
- å¤„ç†æ–¹å‘
- å¤„ç†è‰²å½©è¿‡æ¸¡

ğŸ‘‰ ä½ â€œåªæä¾›èµ·æ­¢è‰²â€ï¼Œ
ğŸ‘‰ **æ¸å˜è®¡ç®—å®Œå…¨äº¤ç»™ Canvas**

------

### 2ï¸âƒ£ ä¸ºä»€ä¹ˆæ¸å˜æ–¹å‘æ˜¯å¯¹çš„ï¼Ÿ

å› ä¸ºä½ ç”¨çš„æ˜¯ï¼š

```js
createLinearGradient(x1, y1, x2, y2)
```

è€Œè¿™ä¸¤ä¸ªç‚¹æ˜¯ï¼š

- å½“å‰å¸§â€œæµåŠ¨æ®µâ€çš„èµ·ç‚¹åƒç´ 
- å½“å‰å¸§â€œæµåŠ¨æ®µâ€çš„ç»ˆç‚¹åƒç´ 

æ‰€ä»¥ï¼š

- çº¿æ€ä¹ˆå¼¯ï¼Œæ¸å˜å°±æ€ä¹ˆå¼¯
- åœ°å›¾æ€ä¹ˆç¼©æ”¾ï¼Œæ¸å˜è‡ªåŠ¨é€‚é…
- ä¸å­˜åœ¨â€œæ–¹å‘é”™ä¹±â€

è¿™æ˜¯ **Canvas + OpenLayers è”åˆå·¥ä½œçš„æ­£ç¡®å§¿åŠ¿**ã€‚

------

## äº”ã€å’Œâ€œå°¾è¿¹æ¸éšâ€æ˜¯æ€ä¹ˆé…åˆçš„ï¼ˆå…³é”®è®¤çŸ¥ï¼‰

ä½ ç°åœ¨çš„å°¾è¿¹æ˜¯é ï¼š

```js
ctx.globalAlpha = alpha;
```

æ¸å˜æ˜¯é ï¼š

```js
gradient.addColorStop(0, startColor);
gradient.addColorStop(1, endColor);
```

ä¸¤è€…**ä¸å†²çªï¼Œè€Œæ˜¯å åŠ **ï¼š

- æ¸å˜ï¼šæ§åˆ¶â€œå‰åé¢œè‰²â€
- alphaï¼šæ§åˆ¶â€œæ—¶é—´è¡°å‡â€

è§†è§‰æ•ˆæœæ˜¯ï¼š

```
ï¼ˆå°¾éƒ¨ï¼‰é€æ˜ + èµ·å§‹è‰²
   â†“
ä¸­æ®µæ¸å˜
   â†“
ï¼ˆå¤´éƒ¨ï¼‰é«˜äº® + ç»“æŸè‰²
```

è¿™æ­£æ˜¯ä½ æˆªå›¾é‡Œé‚£ç§â€œç”µæµæµåŠ¨æ„Ÿâ€ã€‚

------

## å…­ã€åŠ¨ç”»ä¸ºä»€ä¹ˆä¾ç„¶æ˜¯â€œæµåŠ¨çš„â€

è¿™ä¸€ç‚¹éå¸¸é‡è¦ï¼š
**æ¸å˜å¹¶ä¸ä¼šç ´ååŸæœ‰æµåŠ¨æœºåˆ¶**

åŸå› æ˜¯ï¼š

- æµåŠ¨ä»ç„¶ç”± `time / speed` æ§åˆ¶
- æ¯ä¸€å¸§æµåŠ¨æ®µä½ç½®ä¸åŒ
- æ¯ä¸€å¸§æ¸å˜èµ·æ­¢ç‚¹ä¸åŒ

æ‰€ä»¥å³ä¾¿é¢œè‰²æ˜¯â€œé™æ€èµ·æ­¢â€ï¼Œ**ä½ç½®å˜åŒ–ä¾ç„¶åˆ¶é€ æµåŠ¨æ„Ÿ**ã€‚

------

## ä¸ƒã€æ€§èƒ½å±‚é¢æ˜¯å¦å®‰å…¨ï¼ˆä½ è¿™ä¸ªé‡çº§ï¼‰

åœ¨ä½ æè¿°çš„åœºæ™¯ä¸­ï¼š

- ~300 æ¡çº¿
- zoom â‰¥ 13 æ‰æ¸²æŸ“
- æ¯æ¡çº¿åªç”» **å¾ˆçŸ­çš„ä¸€æ®µæµåŠ¨æ®µ**

æ¯ä¸€å¸§çš„é¢å¤–æˆæœ¬åªæœ‰ï¼š

- åˆ›å»ºè‹¥å¹²ä¸ª `LinearGradient`
- ä¸¤æ¬¡ `addColorStop`

è¿™æ˜¯ **Canvas é‡Œéå¸¸è½»çš„æ“ä½œ**ã€‚

ç»“è®ºï¼š

> åœ¨ä½ çš„ä¸šåŠ¡è§„æ¨¡ä¸‹
> **æ€§èƒ½æŸè€—å‡ ä¹å¯ä»¥å¿½ç•¥**

çœŸæ­£é‡çš„æ˜¯ï¼š

- Geometry rebuildï¼ˆä½ æ²¡åšï¼‰
- Feature é‡å»ºï¼ˆä½ æ²¡åšï¼‰
- DOM / WebGLï¼ˆä½ æ²¡ç”¨ï¼‰

------

## å…«ã€ä¸ºä»€ä¹ˆè¿™æ˜¯â€œé•¿æœŸå¯ç»´æŠ¤â€çš„æ–¹æ¡ˆ

è¿™ä¸ªæ–¹æ¡ˆçš„ä¼˜åŠ¿åœ¨äºï¼š

- æ¥å£æç®€ï¼ˆ2 ä¸ªé¢œè‰²ï¼‰
- å‰ç«¯é€»è¾‘ç¨³å®š
- æ¸å˜è§„åˆ™å¯ç»Ÿä¸€å‡çº§
- ä¸å½±å“ç°æœ‰åŠ¨ç”»ç³»ç»Ÿ

ä»¥åä½ ç”šè‡³å¯ä»¥åšåˆ°ï¼š

- å¤œé—´æ¨¡å¼ç»Ÿä¸€æ”¹ endColor
- æ•…éšœçŠ¶æ€æ”¹ startColor
- ä¸åŒé›†ç”µç«™å¥—ä¸åŒé…è‰²æ¨¡æ¿

**æ‰€æœ‰åŠ¨ç”»ä»£ç ä¸€è¡Œä¸åŠ¨ã€‚**

------

## ä¹ã€ä¸€å¥è¯å¸®ä½ å½»åº•è®°ä½

> **åªæä¾›èµ·æ­¢è‰² â‰  è‡ªå·±ç®—é¢œè‰²**
> **è€Œæ˜¯æŠŠâ€œé¢œè‰²æ’å€¼â€äº¤ç»™ Canvasï¼ŒæŠŠâ€œä½ç½®å˜åŒ–â€äº¤ç»™æ—¶é—´**

è¿™å°±æ˜¯ OpenLayers + Canvas åšå·¥ä¸šçº§æµåŠ¨æ•ˆæœçš„æ­£ç¡®å¿ƒæ™ºæ¨¡å‹ã€‚

# x1 / y1 / x2 / y2 çš„æ¥æº

ä½ è¿™ä¸ªé—®é¢˜é—®å¾—**éå¸¸å…³é”®**ï¼Œè€Œä¸”æ­£å¥½å¡åœ¨ **Canvas æ¸å˜â€œçœŸæ­£æ­£ç¡®ç”¨æ³•â€çš„æ ¸å¿ƒç‚¹** ä¸Šã€‚
æˆ‘ç›´æ¥æŠŠ **x1 / y1 / x2 / y2 çš„æ¥æºé“¾è·¯** ä»â€œæ•°æ® â†’ OpenLayers â†’ Canvasâ€å®Œæ•´è®²æ¸…æ¥šã€‚

------

## ä¸€å¥è¯å…ˆç»™ç­”æ¡ˆï¼ˆå…ˆå®šä½ï¼‰

```js
x1, y1, x2, y2
```

**ä¸æ˜¯éšä¾¿ç®—çš„ï¼Œä¹Ÿä¸æ˜¯å†™æ­»çš„**ï¼Œå®ƒä»¬æ¥è‡ªäºï¼š

> **å½“å‰å¸§â€œæµåŠ¨çº¿æ®µâ€çš„èµ·ç‚¹ / ç»ˆç‚¹åæ ‡ â†’ è½¬æˆå±å¹•åƒç´ **

ä¹Ÿå°±æ˜¯è¿™ä¸¤æ­¥ï¼š

```js
const startPixel = map.getPixelFromCoordinate(startCoord);
const endPixel   = map.getPixelFromCoordinate(endCoord);

const [x1, y1] = startPixel;
const [x2, y2] = endPixel;
```

------

## äºŒã€startCoord / endCoord æ˜¯å“ªé‡Œæ¥çš„ï¼Ÿï¼ˆè¿™æ˜¯æ ¸å¿ƒï¼‰

ä½ ç°åœ¨çš„åŠ¨ç”»é€»è¾‘ï¼Œæœ¬è´¨æ˜¯ï¼š

> **åœ¨ä¸€æ¡ LineString ä¸Šï¼ŒæŒ‰â€œé•¿åº¦æ¯”ä¾‹â€æˆªå–ä¸€å°æ®µ**

æµç¨‹æ˜¯ï¼š

```
LineStringï¼ˆå¤šä¸ªç‚¹ï¼‰
  â†“
ç´¯è®¡æ¯ä¸€æ®µçš„é•¿åº¦
  â†“
æ ¹æ® time ç®—å‡º startLen / endLen
  â†“
åœ¨å¯¹åº” segment ä¸Šæ’å€¼å‡ºåæ ‡ç‚¹
```

### 1ï¸âƒ£ å…ˆæœ‰ä¸€æ¡çº¿ï¼ˆåœ°ç†åæ ‡ï¼‰

```js
const coords = geometry.getCoordinates();
// [[lon, lat], [lon, lat], ...]
```

------

### 2ï¸âƒ£ è®¡ç®—æ•´æ¡çº¿çš„æ€»é•¿åº¦ï¼ˆåªç®—ä¸€æ¬¡å¯ç¼“å­˜ï¼‰

```js
const totalLength = geometry.getLength();
```

OpenLayers çš„ `LineString.getLength()`
è¿”å›çš„æ˜¯ **æŠ•å½±åæ ‡ä¸‹çš„é•¿åº¦**ï¼ˆä¸æ˜¯ç±³ï¼Œä½†æ¯”ä¾‹æ­£ç¡®ï¼ŒåŠ¨ç”»å®Œå…¨å¤Ÿç”¨ï¼‰ã€‚

------

### 3ï¸âƒ£ å½“å‰å¸§çš„â€œæµåŠ¨ä½ç½®â€

```js
const time = frameState.time;
const startLen = (time / speed) % totalLength;
const flowLen  = totalLength * 0.1; // æ¯”å¦‚ 10%
const endLen   = startLen + flowLen;
```

æ­¤æ—¶ä½ çŸ¥é“çš„æ˜¯ï¼š

> æˆ‘è¦ç”» `[startLen, endLen]` è¿™ä¸€æ®µ

------

## ä¸‰ã€å¦‚ä½•ä»â€œé•¿åº¦â€å˜æˆâ€œåæ ‡ç‚¹â€ï¼ˆå…³é”®ç®—æ³•ï¼‰

OpenLayers **ä¸ä¼šç›´æ¥å¸®ä½ åšè¿™ä¸€æ­¥**ï¼Œä½†é€»è¾‘å¾ˆç®€å•ã€‚

### ä¼ªä»£ç é€»è¾‘ï¼ˆä½ ç°åœ¨ä»£ç é‡Œå·²ç»æœ‰ï¼‰

```js
let currentLen = 0;

for (æ¯ä¸€æ®µ segment: p0 â†’ p1) {
  const segLen = distance(p0, p1);

  if (currentLen + segLen < startLen) {
    currentLen += segLen;
    continue;
  }

  // è¿›å…¥æµåŠ¨åŒºé—´
  const segStartRatio = Math.max(0, (startLen - currentLen) / segLen);
  const segEndRatio   = Math.min(1, (endLen - currentLen) / segLen);

  const startCoord = interpolate(p0, p1, segStartRatio);
  const endCoord   = interpolate(p0, p1, segEndRatio);

  // ğŸ‘ˆ è¿™ä¸¤ä¸ªç‚¹å°±æ˜¯ä½ è¦çš„
}
```

### æ’å€¼å…¬å¼ï¼ˆæœ€é‡è¦çš„ä¸€è¡Œï¼‰

```js
function interpolate(p0, p1, t) {
  return [
    p0[0] + (p1[0] - p0[0]) * t,
    p0[1] + (p1[1] - p0[1]) * t
  ];
}
```

è¿™ä¸€æ­¥çš„ç»“æœæ˜¯ï¼š

```js
startCoord = [x, y]; // åœ°å›¾åæ ‡
endCoord   = [x, y]; // åœ°å›¾åæ ‡
```

------

## å››ã€ä»â€œåœ°å›¾åæ ‡â€åˆ°â€œCanvas åƒç´ â€ï¼ˆx1,y1 çš„çœŸæ­£æ¥æºï¼‰

ç°åœ¨ä½ å·²ç»æ‹¿åˆ°äº†ï¼š

```js
startCoord = [x, y];
endCoord   = [x, y];
```

è¿™è¿˜**ä¸èƒ½ç›´æ¥ç”¨äº Canvas**ï¼Œå› ä¸ºï¼š

- Canvas ç”»çš„æ˜¯ **å±å¹•åƒç´ **
- åœ°å›¾åæ ‡ä¼šéšç¼©æ”¾ã€å¹³ç§»å˜åŒ–

### æ­£ç¡®ã€å”¯ä¸€çš„åšæ³•æ˜¯ï¼š

```js
const startPixel = map.getPixelFromCoordinate(startCoord);
const endPixel   = map.getPixelFromCoordinate(endCoord);

const x1 = startPixel[0];
const y1 = startPixel[1];
const x2 = endPixel[0];
const y2 = endPixel[1];
```

**è¿™ä¸€æ­¥éå¸¸å…³é”®ï¼š**

- ä½ ä¸ç”¨å…³å¿ƒ zoom
- ä¸ç”¨å…³å¿ƒåˆ†è¾¨ç‡
- ä¸ç”¨å…³å¿ƒåœ°å›¾ä¸­å¿ƒ

OpenLayers å·²ç»å¸®ä½ æŠŠä¸€åˆ‡å˜æ¢éƒ½ç®—å¥½äº†ã€‚

------

## äº”ã€ç°åœ¨è¿™è¡Œä»£ç ç»ˆäºâ€œç«™å¾—ä½äº†â€

```js
const gradient = ctx.createLinearGradient(x1, y1, x2, y2);
gradient.addColorStop(0, startColor);
gradient.addColorStop(1, endColor);

ctx.strokeStyle = gradient;
ctx.stroke();
```

å«ä¹‰æ˜¯ï¼š

> **åœ¨å½“å‰å¸§è¿™â€œä¸€å°æ®µæµåŠ¨çº¿â€ä¸Šï¼Œä»å°¾åˆ°å¤´åšçº¿æ€§æ¸å˜**

è€Œä¸æ˜¯ï¼š

- æ•´æ¡çº¿
- å›ºå®šæ–¹å‘
- å›ºå®šé¢œè‰²

------

## å…­ã€ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ç”¨ segment çš„ p0 / p1ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ª**éå¸¸å¸¸è§çš„é”™è¯¯**ï¼Œæˆ‘å¸®ä½ ç›´æ¥é¿å‘ï¼š

âŒ é”™è¯¯åšæ³•ï¼š

```js
const gradient = ctx.createLinearGradient(p0[0], p0[1], p1[0], p1[1]);
```

åŸå› ï¼š

- p0 / p1 æ˜¯åœ°å›¾åæ ‡
- Canvas éœ€è¦åƒç´ åæ ‡
- ç¼©æ”¾åæ¸å˜æ–¹å‘ä¼šé”™ä¹±

âœ… æ­£ç¡®åšæ³•ï¼š

> **æ°¸è¿œå…ˆ getPixelFromCoordinate**

------

## ä¸ƒã€æ€»ç»“ä¸€å¥è¯ï¼ˆå¸®ä½ å½»åº•è®°ä½ï¼‰

> **x1,y1,x2,y2 = å½“å‰å¸§â€œæµåŠ¨æ®µâ€çš„èµ·æ­¢åæ ‡ â†’ è½¬æˆå±å¹•åƒç´ **

ä¸æ˜¯å†™æ­»çš„
ä¸æ˜¯é¢„è®¡ç®—çš„
ä¸æ˜¯éšä¾¿å–çš„

è€Œæ˜¯ **â€œæ¯ä¸€å¸§å®æ—¶ç®—å‡ºæ¥çš„â€**

------

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥æŠŠ
**â€œé•¿åº¦æˆªå– + æ’å€¼ + åƒç´ è½¬æ¢ + æ¸å˜ç»˜åˆ¶â€**
æ•´ç†æˆä¸€ä¸ªä½ å¯ä»¥ç›´æ¥å¤åˆ¶è¿›é¡¹ç›®çš„ **æœ€ç»ˆç‰ˆå‡½æ•°**ï¼Œä¸“é—¨è§£å†³è¿™ä¸€å—ã€‚

# ä»£ç å®ç°åŒºåˆ«

```ts
 private ensureListening() {
    if (this.listening) return;
    this.layer.on('postrender', (evt: any) => {
      const currentZoom = Math.floor(this.map.getView().getZoom() || 0);
      if (!this.running || !this.linesVisible || this.lines.length === 0 || currentZoom < this.minZoomLevel) return;

      const vectorCtx = getVectorContext(evt);
      const frameState = evt.frameState;
      const transform = frameState.coordinateToPixelTransform;
      const ctx: CanvasRenderingContext2D = evt.context;

      const coordToPixel = (c: Coordinate) => [
        transform[0] * c[0] + transform[2] * c[1] + transform[4],
        transform[1] * c[0] + transform[3] * c[1] + transform[5],
      ];

      for (const line of this.lines) {
        if (line.disposed) continue;
        const geom = line.feature.getGeometry();
        if (!geom) continue;
        const coords = geom.getCoordinates();
        if (coords.length < 2) continue;

        const pStart = coordToPixel(coords[0]);
        const pEnd = coordToPixel(coords[coords.length - 1]);
        const grad = ctx.createLinearGradient(pStart[0], pStart[1], pEnd[0], pEnd[1]);

        const head = line.progress;
        const tailStart = Math.max(0, head - line.tail);

        if (tailStart > 0) grad.addColorStop(0, line.fadeColor);
        grad.addColorStop(tailStart, line.fadeColor);
        grad.addColorStop(head, line.frontColor);
        grad.addColorStop(Math.min(1, head + 0.0001), line.fadeColor);
        grad.addColorStop(1, line.fadeColor);

        vectorCtx.setStyle(new Style({
          stroke: new Stroke({
            color: grad,
            width: line.width,
            lineCap: 'round',
            lineJoin: 'round',
          }),
        }));
        vectorCtx.drawGeometry(geom);

        line.progress += line.speed;
        if (line.progress > 1) line.progress -= 1;
      }
    });
    this.listening = true;
  }
```

è¿™ä¸ªä»£ç ä¹Ÿèƒ½å®ç°æµåŠ¨æ•ˆæœï¼ŒåŒºåˆ«åœ¨å“ªï¼Ÿ

è¿™æ˜¯ä¸€ä¸ª**éå¸¸ä¸“ä¸šã€ä¹Ÿéå¸¸å®¹æ˜“â€œçœ‹èµ·æ¥å¯¹ã€å®é™…ä¸å¯¹â€çš„é—®é¢˜**ã€‚
ä½ çš„ä»£ç åœ¨**è¯­æ³•å’Œç›´è§‰ä¸Šå®Œå…¨åˆç†**ï¼Œä½†å®ƒå’Œæˆ‘ç»™ä½ çš„æ–¹æ¡ˆåœ¨**è¯­ä¹‰å±‚é¢**ä¸Šåšçš„æ˜¯**ä¸¤ä»¶å®Œå…¨ä¸åŒçš„äº‹æƒ…**ã€‚

æˆ‘ç›´æ¥ç”¨**ç»“è®º + å¯¹æ¯” + ä¸ºä»€ä¹ˆä¼šå‡ºé—®é¢˜**çš„æ–¹å¼è¯´æ˜ã€‚

------

## ä¸€ã€å…ˆç»™ç»“è®ºï¼ˆéå¸¸æ˜ç¡®ï¼‰

ä½ å†™çš„è¿™æ®µä»£ç ï¼š

```js
const geom = line.feature.getGeometry();
const coords = geom.getCoordinates();

const pStart = coordToPixel(coords[0]);
const pEnd   = coordToPixel(coords[coords.length - 1]);

const grad = ctx.createLinearGradient(
  pStart[0], pStart[1],
  pEnd[0],   pEnd[1]
);
```

ğŸ‘‰ **è¿™æ˜¯â€œæ•´æ¡çº¿çš„å›ºå®šæ¸å˜â€**

è€Œæˆ‘ç»™ä½ çš„æ–¹æ¡ˆæ˜¯ï¼š

> **â€œå½“å‰å¸§ Â· å½“å‰æµåŠ¨æ®µ Â· åŠ¨æ€æ¸å˜â€**

è¿™ä¸¤è€…çš„å·®åˆ«ä¸æ˜¯å®ç°æ–¹å¼ï¼Œè€Œæ˜¯**åŠ¨ç”»è¯­ä¹‰å®Œå…¨ä¸åŒ**ã€‚

------

## äºŒã€ä½ è¿™æ®µä»£ç åˆ°åº•åœ¨åšä»€ä¹ˆï¼ˆå‡†ç¡®æè¿°ï¼‰

ä½ ç°åœ¨çš„é€»è¾‘æ˜¯ï¼š

1. å– `LineString` çš„ç¬¬ä¸€ä¸ªç‚¹
2. å– `LineString` çš„æœ€åä¸€ä¸ªç‚¹
3. åœ¨**æ•´æ¡çº¿æ–¹å‘ä¸Š**åˆ›å»ºä¸€ä¸ªæ¸å˜
4. ä¸ç®¡ç”»å“ªä¸€æ®µï¼Œæ¸å˜æ–¹å‘æ°¸è¿œä¸å˜

ä¹Ÿå°±æ˜¯è¯´ï¼š

- æ¸å˜æ˜¯ **é™æ€çš„**
- æ¸å˜æ˜¯ **æ•´çº¿çº§åˆ«çš„**
- æ¸å˜ä¸éšåŠ¨ç”»å˜åŒ–

å¦‚æœä½ ç”¨å®ƒæ¥ç”»â€œæµåŠ¨æ®µâ€ï¼Œæ•ˆæœæ˜¯ï¼š

> çº¿åœ¨åŠ¨
> ä½†é¢œè‰²å…³ç³»æ˜¯â€œé’‰æ­»åœ¨æ•´æ¡çº¿ä¸Šçš„â€

------

## ä¸‰ã€ä¸ºä»€ä¹ˆè¿™åœ¨â€œæµåŠ¨åŠ¨ç”»â€é‡Œæ˜¯é”™çš„ï¼ˆå…³é”®ï¼‰

### 1ï¸âƒ£ æµåŠ¨çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ

ä½ ç°åœ¨çš„åŠ¨ç”»ä¸æ˜¯ï¼š

> â€œçº¿åœ¨å˜é¢œè‰²â€

è€Œæ˜¯ï¼š

> **â€œä¸€ä¸ªé«˜äº®æ®µåœ¨æ²¿çº¿ç§»åŠ¨â€**

è¿™ä¸ªâ€œé«˜äº®æ®µâ€æœ¬èº«æ˜¯ä¸€ä¸ª**å±€éƒ¨å¯¹è±¡**ã€‚

------

### 2ï¸âƒ£ ç”¨æ•´æ¡çº¿åšæ¸å˜ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

å‡è®¾ï¼š

- æ•´æ¡çº¿ 1000px
- æµåŠ¨æ®µé•¿åº¦ 80px

ä½ ç”¨çš„æ˜¯ï¼š

```js
gradient(çº¿èµ·ç‚¹ â†’ çº¿ç»ˆç‚¹)
```

é‚£ä¹ˆåœ¨ä»»æ„ä¸€å¸§ï¼š

- è¿™ 80px åªæ˜¯â€œæ•´æ¡æ¸å˜é‡Œçš„ä¸€å°æˆªâ€
- å¤´å°¾é¢œè‰²å‡ ä¹æ²¡æœ‰å˜åŒ–
- **çœ‹ä¸å‡ºæ–¹å‘æ€§**
- **çœ‹ä¸å‡ºâ€œèƒ½é‡åœ¨æµåŠ¨â€**

è§†è§‰ç»“æœæ˜¯ï¼š

> ä¸€æ¡å¸¦é¢œè‰²æ¸å˜çš„çº¿
> ä¸Šé¢æœ‰ä¸€æ®µåœ¨ç§»åŠ¨
> ä½†è¿™æ®µâ€œæ²¡æœ‰è‡ªå·±çš„é¢œè‰²æ–¹å‘â€

------

## å››ã€æˆ‘ç»™ä½ çš„æ–¹æ¡ˆåœ¨åšä»€ä¹ˆï¼ˆæœ¬è´¨åŒºåˆ«ï¼‰

æˆ‘æ–¹æ¡ˆé‡Œæ¸å˜æ˜¯è¿™æ ·ç®—çš„ï¼š

```js
const startPixel = map.getPixelFromCoordinate(flowStartCoord);
const endPixel   = map.getPixelFromCoordinate(flowEndCoord);

const grad = ctx.createLinearGradient(
  startPixel[0], startPixel[1],
  endPixel[0],   endPixel[1]
);
```

æ³¨æ„è¿™å‡ ç‚¹ï¼š

### âœ… 1. èµ·ç‚¹ / ç»ˆç‚¹æ˜¯ã€Œå½“å‰æµåŠ¨æ®µã€

ä¸æ˜¯æ•´æ¡çº¿çš„èµ·ç‚¹
ä¸æ˜¯å›ºå®šç‚¹

è€Œæ˜¯ï¼š

> **è¿™ä¸€å¸§ï¼Œæ­£åœ¨æµåŠ¨çš„é‚£ä¸€å°æ®µçš„èµ·ç‚¹å’Œç»ˆç‚¹**

------

### âœ… 2. æ¸å˜æ–¹å‘ = æµåŠ¨æ–¹å‘

- æµåŠ¨æ®µæ€ä¹ˆèµ°
- æ¸å˜å°±æ€ä¹ˆèµ°
- æ¯ä¸€å¸§éƒ½ä¼šå˜åŒ–

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ çœ‹åˆ°çš„æ˜¯ï¼š

> â€œé¢œè‰²åœ¨å¾€å‰æ¨â€

è€Œä¸æ˜¯ï¼š

> â€œçº¿æœ¬èº«æœ‰ä¸ªæ¸å˜â€

------

## äº”ã€ä¸€ä¸ªæç«¯å¯¹æ¯”ä¾‹å­ï¼ˆå¸®ä½ ç§’æ‡‚ï¼‰

å‡è®¾ï¼š

- ä¸€æ¡çº¿æ˜¯ä¸ª **U å‹**
- æµåŠ¨æ®µç°åœ¨åœ¨å·¦ä¾§ç«–çº¿
- ä¸‹ä¸€å¸§åœ¨åº•éƒ¨æ¨ªçº¿

### ä½ çš„æ–¹æ¡ˆï¼š

- æ¸å˜æ–¹å‘ï¼š
  **å§‹ç»ˆæ˜¯ã€Œæ•´æ¡çº¿é¦–å°¾çš„æ–¹å‘ã€**
- åœ¨æ‹å¼¯å¤„ï¼š
  - æ¸å˜æ–¹å‘å’Œçº¿æ–¹å‘ä¸¥é‡ä¸ä¸€è‡´
  - é«˜äº®æ®µçœ‹èµ·æ¥â€œé¢œè‰²åœ¨æ¨ªç€åˆ·â€

### æˆ‘çš„æ–¹æ¡ˆï¼š

- æ¸å˜æ–¹å‘ï¼š
  **å§‹ç»ˆæ˜¯ã€Œå½“å‰æ®µçš„æ–¹å‘ã€**
- åœ¨æ‹å¼¯å¤„ï¼š
  - æ¸å˜è‡ªåŠ¨æ—‹è½¬
  - æµåŠ¨è¿ç»­ã€è‡ªç„¶

ğŸ‘‰ **è¿™åœ¨æµ·ç¼†è¿™ç§å¯èƒ½æœ‰æŠ˜çº¿çš„åœºæ™¯é‡Œéå¸¸é‡è¦**

------

## å…­ã€ä»€ä¹ˆæ—¶å€™ä½ è¿™ç§å†™æ³•æ˜¯â€œå¯¹çš„â€ï¼Ÿ

å…¬å¹³åœ°è¯´ï¼Œä½ çš„å†™æ³•**ä¸æ˜¯ä¸€æ— æ˜¯å¤„**ï¼Œå®ƒé€‚ç”¨äºï¼š

- â‡ é™æ€ç®¡çº¿
- â‡ ä¸éœ€è¦æµåŠ¨
- â‡ åªæ˜¯æƒ³è¡¨è¾¾â€œä» A åˆ° B çš„èƒ½é‡ç­‰çº§å˜åŒ–â€

ä¾‹å¦‚ï¼š

- è¾“ç”µå®¹é‡åˆ†å¸ƒ
- å‹åŠ›è¡°å‡
- é£é€Ÿå˜åŒ–

ä½† **ä¸é€‚ç”¨äºâ€œæµåŠ¨åŠ¨ç”»â€**ã€‚

------

## ä¸ƒã€æ ¸å¿ƒå·®å¼‚æ€»ç»“ï¼ˆç”¨ä¸€å¥è¯ï¼‰

> ä½ çš„æ˜¯ï¼š
> **â€œçº¿æœ‰æ¸å˜ï¼ŒåŠ¨ç”»åªæ˜¯ç§»åŠ¨ä½ç½®â€**

> æˆ‘çš„æ˜¯ï¼š
> **â€œæ¸å˜è·Ÿç€æµåŠ¨æ®µä¸€èµ·èµ°â€**

------

## å…«ã€ç»™ä½ ä¸€ä¸ªåˆ¤æ–­æ ‡å‡†ï¼ˆä»¥åä¸ä¼šå†çº ç»“ï¼‰

åªé—®è‡ªå·±ä¸€å¥è¯ï¼š

> **è¿™ä¸ªæ¸å˜ï¼Œæ˜¯æè¿°â€œçº¿â€ï¼Œè¿˜æ˜¯æè¿°â€œæ­£åœ¨æµåŠ¨çš„ä¸œè¥¿â€ï¼Ÿ**

- æè¿°â€œçº¿â€ â†’ ä½ ç°åœ¨çš„å†™æ³•

  æè¿°â€œæµåŠ¨â€ â†’ å¿…é¡»ç”¨æˆ‘ç»™ä½ çš„å†™æ³•

------

