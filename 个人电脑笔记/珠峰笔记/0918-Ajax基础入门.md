## Ajax (async javascript and xml)

> 基于JS完成“客户端”和“服务器端”的“数据交互”。

### async javascript and xml名词解释

- async javascript 异步的JS并不是我们学习到的“JS中的同步异步编程”（当然真实项目中，虽然我们可以发送同步的ajax请求，但是一般我们全部都是用异步的方式处理）；这里的异步代指的是“局部刷新”；
- xml
  - html/xhtml 所有使用的标签都是W3C规定的
  - xml 可以自己扩展的标记语言（作用：基于一些自定义标签，清晰且有结构性的存储数据）
  - 最早期，我们从服务器获取的数据，一般以xml格式的数据为主，只不过后来，诞生了比xml处理起来更加方便的数据格式“JSON数据格式”（特色：对象的属性名是基于“”包裹起来的）
  - 当下和服务器端的数据交互，传输的数据格式一般都以JSON格式的数据为主（JSON格式的字符串/对象）

###  JSON格式的对象

```json
let data = [
{
    "name": "张三",
    "age": 25,
    "score": {
        "chinese": 98,
        "math": 100,
        "english": 12
    }
}, {
    "name": "李四",
    "age": 26,
    "score": {
        "chinese": 58,
        "math": 68,
        "english": 97
    }
}
}];
```

### AJAX/XHR发生请求过程

#### 1.创建一个AJAX/XHR实例对象

```
let xhr = new XMLHttpRequest;
```

#### 2.打开请求的链接地址（发送数据请求之前的一些配置信息）

```
xhr.open([method],[url][,async][,username][,userpass])
```

- method请求方式
  - GET：get/head/delete/options...
  -  POST：post/put...
- url 请求的URL地址
- async 设置同步还是异步发送请求，默认true，代表异步操作
- username/userpass 发送请求的时候，可能应服务器的需求提供校验的用户名和密码

- 配置请求头信息：基于请求头传递给服务器的信息中不允许出现中文或者一些特殊符号

  ```
  xhr.open('get', 'http://127.0.0.1:5500/1.json');
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencode');
  xhr.setRequestHeader('refer', 'baidu.com');
  ```

#### 3.监听XHR的状态改变，onreadystatechange事件

##### `xhr.readyState` --- AJAX状态

- 0 UNSEND 未发送（初始化成功后的状态）
- 1 OPENED 已打开（已经执行了xhr.open）
- 2 HEADERS_RECEIVED 接收到服务器返回的响应头信息（已经发送ajax请求，并且服务器返回了部分数据）
- 3 LOADING 服务器正在返回响应主体信息
-  4 DONE 服务器已经把所有的响应信息（响应头+响应主体）都返回给客户端了（当前AJAX异步请求的任务结束）

##### `xhr.status` ---- 服务器返回的HTTP网络状态码

| 分类 | 分类描述                                       |
| :--- | :--------------------------------------------- |
| 1**  | 信息，服务器收到请求，需要请求者继续执行操作   |
| 2**  | 成功，操作被成功接收并处理                     |
| 3**  | 重定向，需要进一步的操作以完成请求             |
| 4**  | 客户端错误，请求包含语法错误或无法完成请求     |
| 5**  | 服务器错误，服务器在处理请求的过程中发生了错误 |

- 200 OK 成功
- 206 Partial Content 传递大文件信息的信息，基于切片上传和断点续传一般走这个状态码
- 301 Moved Permanently 永久转移(永久重定向)  例如：域名迁移
- 302 Move Temporarily 临时转移(之前是临时重定向，只不过后来 307 Temporary Redirect 代表临时重定向) 例如：服务器负载均衡
- 304 Not Modified 协商缓存

​    **4开头的问题一般是客户端出现问题**

- 400 Bad Request 请求参数错误
- 401 Unauthorized 权限校验失败  例如：token信息
- 403 Forbidden  服务器理解请求客户端的请求，但是拒绝执行此请求
- 404 Not Found 请求地址不存在
- 405 Method Not Allowed 请求方式是不被服务器支持
- 408 Request Timeout 请求超时

​    **5开头的问题一般是服务器问题**

- 500 Internal Server Error 服务器未知错误
- 503 Service Unavailable 服务器超负荷

##### onreadystatechange 事件

> 当请求被发送到服务器时，我们需要执行一些基于响应的任务。每当 readyState 改变时，就会触发 onreadystatechange 事件。

在 onreadystatechange 事件中，我们规定当服务器响应已做好被处理的准备时所执行的任务。

当 readyState 等于 4 且状态为 200 时，表示响应已就绪：

```js
xhr.onreadystatechange = function () {
    // console.log(xhr.readyState); //2 3 4  此方法会被执行三次

    if (/^2\d{2}$/.test(xhr.status) && xhr.readyState === 4) {
        // 成功从服务器获取数据
        // let data = JSON.parse(xhr.responseText);
        // console.log(data);

        // 获取服务器返回的响应头信息中的内容
        // console.log(xhr.getResponseHeader('date'));
        // console.log(xhr.getAllResponseHeaders());
    }
};
```

#### 4.发送ajax数据请求（当前AJAX异步请求的任务开始,将请求发送到服务器）

```js
xhr.send(null);
```

## Ajax基础操作汇总

### 核心四步

- 创建XHR（ActiveXObject）
- 打开URL
- 监听状态和获取数据
- 发送请求

### HTTP请求方式

- GET：GET、DELETE、HEAD、OPTIONS
- POST：POST、PUT
- GET和POST系列的区别
  - 传递信息的方式
  - POST相对安全
  - GET容易产生缓存

### AJAX状态码

- 0 =>UNSENT
- 1 =>OPENED
- 2 =>HEADERS_RECEIVED
- 3 =>LOADING
- 4 =>DONE

### 汇总XHR的属性和方法及事件

- xhr.response / xhr.responseText / xhr.responseXML
- xhr.status / xhr.statusText
- xhr.timeout
- xhr.withCredentials
- xhr.abort()
- xhr.getAllResponseHeaders()
- xhr.getResponseHeader([key])
- xhr.open()
- xhr.overrideMimeType()
- xhr.send()
- xhr.setRequestHeader()