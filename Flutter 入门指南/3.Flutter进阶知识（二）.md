# Flutter中如何管理运行脚本

## 使用 Makefile（推荐）



使用makeflie的方式需要现安装`make`工具。

### 安装 Make（选择以下任一方式）

#### 方式1：通过 Chocolatey 安装（推荐）

```bash
# 1. 先安装 Chocolatey（如果没有）
# 以管理员身份运行 PowerShell，执行：
Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

# 2. 安装 make
choco install make
```

#### 方式2：通过 Git Bash 安装

```bash
# 如果你已经安装了 Git for Windows，可以在 Git Bash 中使用以下命令
pacman -S make
```

#### 方式3：直接下载

1. 访问 [GnuWin32](http://gnuwin32.sourceforge.net/packages/make.htm)
2. 下载 make-3.81.exe
3. 安装并添加到系统环境变量

### 验证安装

安装完成后，打开新的命令行窗口，验证安装：

```bash
make --version
```

### 使用 Makefile

1. 确保 Makefile 文件名正确：

   - 文件名必须是 Makefile 或 makefile

   - 注意大小写（Windows 不区分大小写，但建议使用 Makefile）

2. 在项目根目录创建 Makefile

   ```makefile
   # Makefile
   .PHONY: run-dev run-prod build-dev build-prod clean
   
   # 开发环境运行
   run-dev:
   	flutter run --dart-define=ENVIRONMENT=development 
   
   # 生产环境运行
   run-prod:
   	flutter run --dart-define=ENVIRONMENT=production
   
   # 开发环境构建
   build-dev:
   	flutter build web --dart-define=ENVIRONMENT=development
   
   # 生产环境构建
   build-prod:
   	flutter build web --dart-define=ENVIRONMENT=production
   
   # 清理项目
   clean:
   	flutter clean
   	flutter pub get
   ```

   > .PHONY 告诉 Make 命令，后面列出的这些目标（targets）不是真实的文件名，而是一个命令的名字。



其他可选的参数：

```makefile
run-dev:
	flutter run \
		--dart-define=ENVIRONMENT=development \
		--hot \           # 热重载
		--hot-reload \    # 热重载（显式指定）
		--debug \         # 调试模式
		--pid-file=pid    # 保存进程ID
```



### 执行命令

在项目根目录下打开终端（可以是 CMD、PowerShell 或 Git Bash），执行：

```bash
# 运行开发环境
make run-dev

# 运行生产环境
make run-prod

# 构建开发版本
make build-dev

# 构建生产版本
make build-prod

# 清理项目
make clean
```

### 热重载

使用终端启动应用时，需要手动按下r才会执行热重载。

![image-20250428163922322](https://s2.loli.net/2025/04/28/wClFTndxNZfPLvR.png)

如果使用vscode则会自动帮我们热重载。

## 使用 shell 脚本

创建 scripts 目录，添加脚本文件：

```bash
# scripts/run.sh
#!/bin/bash

case $1 in
  "dev")
    flutter run --dart-define=ENVIRONMENT=development
    ;;
  "prod")
    flutter run --dart-define=ENVIRONMENT=production
    ;;
  *)
    echo "Usage: ./run.sh [dev|prod]"
    ;;
esac
```

使用方式：

```bash
# 先添加执行权限
chmod +x scripts/run.sh

# 运行
./scripts/run.sh dev
./scripts/run.sh prod
```

## 使用 VS Code 任务配置

在 .vscode/tasks.json 中配置：

```bash
{
  "version": "2.0.0",
  "tasks": [
    {
      "label": "Run Development",
      "type": "shell",
      "command": "flutter",
      "args": [
        "run",
        "--dart-define=ENVIRONMENT=development"
      ],
      "group": {
        "kind": "build",
        "isDefault": true
      }
    },
    {
      "label": "Run Production",
      "type": "shell",
      "command": "flutter",
      "args": [
        "run",
        "--dart-define=ENVIRONMENT=production"
      ]
    }
  ]
}
```

使用方式：

- 在 VS Code 中按 Ctrl/Cmd + Shift + P

- 输入 Tasks: Run Task

- 选择对应的任务

## 使用 Flutter Launcher 配置

在 launch.json 中配置：

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Flutter Development",
      "request": "launch",
      "type": "dart",
      "args": [
        "--dart-define=ENVIRONMENT=development"
      ]
    },
    {
      "name": "Flutter Production",
      "request": "launch",
      "type": "dart",
      "args": [
        "--dart-define=ENVIRONMENT=production"
      ]
    }
  ]
}
```

使用方式：

- 在 VS Code 的运行和调试面板中选择对应的配置

- 点击运行或按 F5

# typedef (类型别名)

```dart
// 基本语法
typedef 新类型名 = 已存在的类型;

// 例子
typedef OrgList = List<Org>;  // OrgList 现在就是 List<Org> 的别名
typedef JsonMap = Map<String, dynamic>;  // 常用于表示 JSON 数据
typedef Callback = void Function(String);  // 函数类型的别名

// 使用示例
OrgList orgs = [];  // 等同于 List<Org> orgs = [];
JsonMap json = {'name': 'test'};  // 等同于 Map<String, dynamic> json = {'name': 'test'};
```

```dart
class Org {
  final String organizationName;
  final String sysOrganizationId;

  Org({
    required this.organizationName,
    required this.sysOrganizationId,
  });

  factory Org.fromJson(Map<String, dynamic> json) {
    return Org(
      organizationName: json['organizationName'] ?? '',
      sysOrganizationId: json['sysOrganizationId'] ?? '',
    );
  }
}

typedef OrgList = List<Org>;
```

typedef 的好处：

1. 简化复杂类型的书写
2. 提高代码可读性
3. 方便类型复用
4. 当需要修改类型时，只需要改一处

# extension（扩展）

```dart
// 基本语法
extension 扩展名 on 要扩展的类型 {
  // 可以添加方法
  返回类型 方法名() {
    // 方法实现
  }
  
  // 可以添加 getter
  类型 get 属性名 => 实现;
}

// 实际例子
extension StringHelper on String {
  // 添加方法
  bool isValidEmail() {
    return RegExp(r'^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$').hasMatch(this);
  }
  
  // 添加 getter
  bool get isNotEmpty => this.length > 0;
}

// 使用示例
String email = 'test@example.com';
print(email.isValidEmail());  // true
print(email.isNotEmpty);  // true
```

```dart
typedef OrgList = List<Org>;

extension OrgListParser on OrgList {
  static OrgList fromJson(List<dynamic> json) {
    return json.map((item) => Org.fromJson(item)).toList();
  }
}
```

案例代码：

```dart
// 1. 定义类型别名
typedef OrgList = List<Org>;  // OrgList 就是 List<Org> 的别名

// 2. 给 OrgList 添加解析 JSON 的功能
extension OrgListParser on OrgList {
  // 静态方法，用于从 JSON 创建 OrgList
  static OrgList fromJson(List<dynamic> json) {
    return json.map((item) => Org.fromJson(item)).toList();
  }
}

// 使用示例
void main() {
  // 使用 typedef
  OrgList orgs = [];  // 等同于 List<Org> orgs = [];
  
  // 使用 extension
  final jsonData = [
    {'organizationName': '测试', 'sysOrganizationId': '123'}
  ];
  OrgList orgList = OrgListParser.fromJson(jsonData);
  
  // 因为 OrgList 就是 List<Org>，所以可以使用所有 List 的方法
  orgList.forEach((org) => print(org.organizationName));
  orgList.map((org) => org.sysOrganizationId).toList();
  orgList.where((org) => org.organizationName.contains('测试')).toList();
}
```

extension 的好处：

1. 不修改原类的情况下添加新功能
2. 代码组织更清晰
3. 提供更好的代码提示
4. 可以给任何类型添加扩展方

## 实际应用场景

```dart
// 1. 给 String 添加实用方法
extension StringUtils on String {
  String capitalize() => '${this[0].toUpperCase()}${this.substring(1)}';
}

// 2. 给 DateTime 添加格式化方法
extension DateTimeFormatter on DateTime {
  String toCustomFormat() => '${year}-${month}-${day}';
}

// 3. 给 List 添加实用方法
extension ListUtils<T> on List<T> {
  T? firstWhereOrNull(bool Function(T) test) {
    try {
      return firstWhere(test);
    } catch (_) {
      return null;
    }
  }
}

// 使用示例
void main() {
  print('hello'.capitalize());  // Hello
  print(DateTime.now().toCustomFormat());  // 2024-03-20
  
  final list = [1, 2, 3];
  final item = list.firstWhereOrNull((e) => e > 5);  // null
}
```

# 使用flutter_dotenv管理环境配置

1. 首先创建不同环境的 .env 文件：

   ```bash
   # .env.development
   API_URL=http://dev-api.example.com
   SM2_PUBLIC_KEY=dev_public_key
   
   # .env.production
   API_URL=http://api.example.com
   SM2_PUBLIC_KEY=prod_public_key
   
   # .env.staging
   API_URL=http://staging-api.example.com
   SM2_PUBLIC_KEY=staging_public_key
   ```

2. 添加依赖

   ```yaml
   # pubspec.yaml
   dependencies:
   	flutter_dotenv: ^5.0.2
   ```

   ```yaml
   flutter:
     assets:
       - .env.development
       - .env.production
       - .env.staging
   ```

3. 创建环境配置类

   ```dart
   // lib/core/config/index.dart
   import 'package:flutter_dotenv/flutter_dotenv.dart';
   
   class Environment {
     static String currentEnvironment = 'development';
   
     static Future<void> initialize() async {
       String envFile = '.env.${currentEnvironment}';
       await dotenv.load(fileName: envFile);
     }
   
     static String get fileName => '.env.$currentEnvironment';
   
     static bool get isDevelopment => currentEnvironment == 'development';
     static bool get isProduction => currentEnvironment == 'production';
     static bool get isStaging => currentEnvironment == 'staging';
   }
   
   class EnvConfig {
     static String get apiUrl => dotenv.env['API_URL'] ?? '';
     static String get sm2PublicKey => dotenv.env['SM2_PUBLIC_KEY'] ?? '';
     
     // 其他配置项...
     static Map<String, dynamic> get all => dotenv.env;
   }
   ```

4. 在 main.dart 中根据环境初始化：

   ```dart
   // lib/main.dart
   import 'core/config/index.dart';
   
   Future<void> main() async {
     WidgetsFlutterBinding.ensureInitialized();
     
     // 设置当前环境
     const String env = String.fromEnvironment(
       'ENVIRONMENT',
       defaultValue: 'development',
     );
     Environment.currentEnvironment = env;
     
     // 加载对应的环境配置
     await Environment.initialize();
     
     runApp(MyApp());
   }
   ```

5. 运行时指定环境

   ```bash
   # 开发环境
   flutter run --dart-define=ENVIRONMENT=development
   
   # 生产环境
   flutter run --dart-define=ENVIRONMENT=production
   
   # 测试环境
   flutter run --dart-define=ENVIRONMENT=staging
   ```

6. 在代码中使用

   ```dart
   // 示例用法
   void someFunction() {
     if (Environment.isDevelopment) {
       print('开发环境');
       print('API URL: ${EnvConfig.apiUrl}');
       print('Public Key: ${EnvConfig.sm2PublicKey}');
     }
     
     if (Environment.isProduction) {
       print('生产环境');
       // 生产环境特定的逻辑
     }
   }
   ```

7. 可以添加一个便捷的配置检查方法

   ```dart
   class EnvConfig {
     // ... 之前的代码 ...
   
     static void validateConfig() {
       assert(apiUrl.isNotEmpty, 'API_URL is not configured in ${Environment.fileName}');
       assert(sm2PublicKey.isNotEmpty, 'SM2_PUBLIC_KEY is not configured in ${Environment.fileName}');
       
       print('当前环境: ${Environment.currentEnvironment}');
       print('配置检查完成');
     }
   }
   
   // 在 main.dart 中使用
   void main() async {
     await Environment.initialize();
     if (Environment.isDevelopment) {
       EnvConfig.validateConfig(); // 仅在开发环境验证配置
     }
     runApp(MyApp());
   }
   ```

8. 为了安全起见，添加 .gitignore：

   ```gitignore
   # .gitignore
   .env*
   !.env.example
   ```

9.提供一个示例配置文件：

```dart
# .env.example
API_URL=http://example.com
SM2_PUBLIC_KEY=your_public_key_here
```

