# 10.iptables禁止外部访问指定端口&指定日志输出

> 场景：服务器上部署的项目起的端口是6752，用nginx转发到了一个二级域名，但是还是能用ip地址:6752访问到项目。
>
> 需求：只能用域名访问，禁止直接用ip访问。

原本打算还是用nginx来管控ip+端口的访问，但是发现这样配置会导致nginx启动报错，具体原因不清楚。

```nginx
{
	listen 80 default_server;
	listrn 6752 default_server;
	server_name _;
	return 403;
}
```

最后发现使用iptables来管理外部访问流量更好。

## 使用iptables配置端口访问规则

禁止外部访问6752端口，允许本机访问6752端口

```sh
# 允许本机访问 6752 端口
sudo iptables -A INPUT -p tcp --dport 6752 -s 127.0.0.1 -j ACCEPT

# 禁止外部访问 6752 端口
sudo iptables -A INPUT -p tcp --dport 6752 -j DROP
```

- `-A INPUT`：在 INPUT 链（处理输入流量的规则链）的末尾添加一条新的规则。
- `-p tcp`：指定协议为 TCP。
- `--dport 6752`：指定目标端口为 6752。
- `-s 127.0.0.1`：指定源 IP 地址为 127.0.0.1，也就是本机。
- `-j ACCEPT`：如果流量匹配了这条规则，那么就**接受**这个流量。
- `-j DROP`：如果流量匹配了这条规则，那么就**丢弃**这个流量。

这两条规则的顺序很重要，因为 iptables 会按照规则的顺序来处理流量，一旦流量匹配了一条规则，就不会再去匹配后面的规则。所以，我们需要先允许本机访问 6752 端口，然后再禁止所有其他的流量访问 6752 端口。

## 记录拦截访问的日志

```sh
iptable -I INPUT 1
```

