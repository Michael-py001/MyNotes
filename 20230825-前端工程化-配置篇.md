# 20230805-å‰ç«¯å·¥ç¨‹åŒ–-é…ç½®ç¯‡

## lint-staged

> https://github.com/okonet/lint-staged

`lint-staged` æ˜¯ä¸€ä¸ª Git é’©å­å·¥å…·ï¼Œå®ƒå¯ä»¥åœ¨ Git æ“ä½œæ—¶è§¦å‘æŒ‡å®šçš„è„šæœ¬ï¼Œç”¨äºå¯¹æš‚å­˜åŒºä¸­çš„æ–‡ä»¶è¿›è¡Œä»£ç æ£€æŸ¥ã€æ ¼å¼åŒ–ç­‰æ“ä½œã€‚

### why?

åœ¨æäº¤ä»£ç ä¹‹å‰è¿è¡Œ Linting æ›´æœ‰æ„ä¹‰ã€‚é€šè¿‡è¿™æ ·åšï¼Œæ‚¨å¯ä»¥ç¡®ä¿æ²¡æœ‰é”™è¯¯è¿›å…¥å­˜å‚¨åº“å¹¶å¼ºåˆ¶å®æ–½ä»£ç æ ·å¼ã€‚ä½†æ˜¯åœ¨æ•´ä¸ªé¡¹ç›®ä¸Šè¿è¡Œ lint è¿›ç¨‹å¾ˆæ…¢ï¼Œå¹¶ä¸” lint ç»“æœå¯èƒ½æ— å…³ç´§è¦ã€‚æœ€ç»ˆï¼Œæ‚¨åªæƒ³æ£€æŸ¥å°†è¦æäº¤çš„æ–‡ä»¶ã€‚

### å®‰è£…å’Œè®¾ç½®

1. å®‰è£…`lint-staged`:
   - `npm install --save-dev lint-staged`
2. è®¾ç½®`pre-commit`git hookä»¥è¿è¡Œ*lint-stage*
3. å®‰è£…ä¸€äº›linters(æ ¼å¼åŒ–/ä»£ç è§„èŒƒæ ¡éªŒå·¥å…·)ï¼Œæ¯”å¦‚ [ESLint](https://eslint.org/) or [Prettier](https://prettier.io/)
4. é…ç½®*lint-staged*ä»¥è¿è¡Œlintersæˆ–è€…å…¶ä»–ä»»åŠ¡
   - ä¾‹å¦‚ï¼š `{ "*.js": "eslint" }` ä¸ºæ‰€æœ‰æš‚å­˜çš„ JS æ–‡ä»¶è¿è¡Œ ESLint
   -  æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…[é…ç½®](https://github.com/okonet/lint-staged#configuration)

### package.jsoné…ç½®

> å®˜æ–¹è¿˜æ”¯æŒå¤šç§é…ç½®æ–¹å¼ï¼Œè¯¦æƒ…è¯·çœ‹[æ–‡æ¡£](https://github.com/okonet/lint-staged#configuration)

```json
{
     "lint-staged": {
        "*.{ts,tsx,js,cjs}": [
          "rome format --write",
          "rome check"
        ],
        "*.{md,html,css,json,yml}": "prettier --write",
        "!(*pnpm-lock).yaml": "prettier --write",
        "package.json": "pnpm sort-package-json"
      },
}
```

```json
{
  "lint-staged": {
    "*": "your-cmd"
  }
}
```



## rome

> [Rome â€” Unified developer tools for JavaScript, TypeScript, and the web](https://rome.tools/)

romeæ˜¯ä¸€ä¸ªå¯ä»¥åŒæ—¶æ”¯æŒformat(æ ¼å¼åŒ–)å’Œlint(ä»£ç è§„èŒƒæ ¡éªŒ)çš„å·¥å…·ï¼Œç”¨ä¸Šè¿™ä¸ªå·¥å…·åå¯ä»¥å°±ä¸ç”¨åŒæ—¶å®‰è£…ESLintå’ŒPrettieräº†ã€‚å•ä¸ªé…ç½®æ–‡ä»¶ï¼ŒæƒŠäººçš„æ€§èƒ½ï¼Œé€‚ç”¨äºä»»ä½•æ ˆã€‚

### Formatter æ ¼å¼åŒ–

#### Options é€‰é¡¹

- ç¼©è¿›æ ·å¼ï¼ˆé»˜è®¤ï¼š `tab` ï¼‰ï¼šä½¿ç”¨ç©ºæ ¼æˆ–åˆ¶è¡¨ç¬¦è¿›è¡Œç¼©è¿›
- åˆ¶è¡¨ç¬¦å®½åº¦ï¼ˆé»˜è®¤å€¼ï¼š `2` ï¼‰ï¼šæ¯ä¸ªç¼©è¿›çº§åˆ«çš„ç©ºæ ¼æ•°
- è¡Œå®½ï¼ˆé»˜è®¤ï¼š `80` ï¼‰ï¼šç½—é©¬æ¢è¡Œä»£ç çš„åˆ—å®½

æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…[é…ç½®é€‰é¡¹](https://docs.rome.tools/configuration)ã€‚

æ¡ˆä¾‹ï¼š

```json
{
"formatter": {
    "enabled": true,
    "indentSize": 2,
    "indentStyle": "space",
    "formatWithErrors": true,
    "lineWidth": 80,
    "ignore": ["dist/**/*.js"]
  },
}
```

### Linter ä»£ç æ ¡éªŒ

linter é™æ€åˆ†ææ‚¨çš„ä»£ç ä»¥æ•è·å¸¸è§é”™è¯¯å¹¶å¸®åŠ©ç¼–å†™æƒ¯ç”¨ä»£ç ã€‚å…±æœ‰[154æ¡è§„åˆ™](https://docs.rome.tools/lint/rules)ã€‚

#### é€šè¿‡ CLI ä½¿ç”¨Linter

æ‚¨å¯ä»¥ä»è¿è¡Œå¸¦æœ‰æ ‡å¿— `--help` çš„ CLI å¼€å§‹ï¼š

```bash
pnpm rome check --help
```

é€šè¿‡æ­¤å‘½ä»¤å¯ä»¥å‘ŠçŸ¥ä½ å¯ç”¨çš„æŒ‡ä»¤

#### Code fixes ä»£ç ä¿®å¤

Lint è§„åˆ™å¯èƒ½ä¼šæä¾›è‡ªåŠ¨ä»£ç ä¿®å¤ã€‚ç½—é©¬åŒºåˆ†äº†ä¸¤ç§ç±»å‹çš„ä¿®å¤ï¼š

- safe fixes å®‰å…¨ä¿®å¤
- unsafe fixes ä¸å®‰å…¨çš„ä¿®å¤

å®‰å…¨ä¿®å¤ä¿è¯ä¸ä¼šæ›´æ”¹ä»£ç çš„è¯­ä¹‰ã€‚æ— éœ€æ˜ç¡®å®¡æŸ¥å³å¯åº”ç”¨å®ƒä»¬ã€‚

è¦åº”ç”¨å®‰å…¨ä¿®å¤ï¼Œè¯·ä½¿ç”¨ `--apply` ï¼š

```bash
rome check --apply ./src
```

ä¸å®‰å…¨çš„ä¿®è¡¥ç¨‹åºå¯èƒ½ä¼šæ›´æ”¹ç¨‹åºçš„è¯­ä¹‰ã€‚å› æ­¤ï¼Œå»ºè®®æ‰‹åŠ¨æŸ¥çœ‹æ›´æ”¹ã€‚

è¦åº”ç”¨ä¸å®‰å…¨çš„ä¿®å¤ç¨‹åºï¼Œè¯·ä½¿ç”¨ `--apply-unsafe` ï¼š

```bash
rome check --apply-unsafe ./src
```

#### Configuration é…ç½®

##### å¯ç”¨ lint è§„åˆ™

é»˜è®¤æƒ…å†µä¸‹ï¼Œå»ºè®®çš„è§„åˆ™å¤„äºå¯ç”¨çŠ¶æ€ï¼Œå¹¶å‘å‡ºå…·æœ‰é”™è¯¯ä¸¥é‡æ€§çš„è¯Šæ–­ä¿¡æ¯ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸æ¨èçš„è§„åˆ™å¤„äºç¦ç”¨çŠ¶æ€ï¼Œä½†å¯ä»¥é€šè¿‡é…ç½®å¯ç”¨å®ƒä»¬ã€‚è¿™äº›è§„åˆ™å‘å‡ºçš„è¯Šæ–­ä¿¡æ¯ä¸è­¦å‘Šä¸¥é‡æ€§ä¸€èµ·æ˜¾ç¤ºåœ¨æ–‡æ¡£ä¸­ã€‚

è‹¥è¦å¯ç”¨è§„åˆ™ï¼Œéœ€è¦æ ¹æ®éœ€è¦æ›´æ”¹å…¶è¯Šæ–­ä¸¥é‡æ€§ï¼š

```json
{
  "linter": {
    "enabled": true,
    "rules": {
      "style": {
        "useBlockStatements": "error",
        "useShorthandArrayType": "error",
        "noShoutyConstants": "warn"
      }
    }
  }
}
```

##### ç¦ç”¨ lint è§„åˆ™

åªéœ€åœ¨å…¶é…ç½®ä¸­æ·»åŠ  `"off"` å€¼å³å¯ã€‚ä¾‹å¦‚ï¼š

```json
{
  "linter": {
    "enabled": true,
    "rules": {
      "suspicious": {
        "noCommentText": "off"
      },
      "style": {
        "noUnusedTemplateLiteral": "off"
      }
    }
  }
}
```

##### linter.rules.recommended

Enables the [recommended rules](https://docs.rome.tools/lint/rules) for all groups. å¯ç”¨æ¨èçš„è§„åˆ™

## prettier

è¿™ä¸ªä¼°è®¡éƒ½å¾ˆæ™®éä½¿ç”¨ï¼Œä¸Šé¢romeä¸æ”¯æŒçš„ç±»å‹æ–‡ä»¶ï¼Œå¯ä»¥äº¤ç»™prettierå¤„ç†ã€‚

æ¯”å¦‚ï¼š`md,html,css,json,yml`ç­‰æ ¼å¼æ–‡ä»¶ã€‚

```json
{
    "lint-staged": {
        "*.{ts,tsx,js,cjs}": [
          "rome format --write",
          "rome check"
        ],
        "*.{md,html,css,json,yml}": "prettier --write",
        "!(*pnpm-lock).yaml": "prettier --write",
      },
}
```

## sort-package-json

ä¸€ä¸ªå¯ä»¥æ ¼å¼åŒ–package.jsonçš„æ’ä»¶ã€‚

> [keithamus/sort-package-json: Sort an Object or package.json based on the well-known package.json keys (github.com)](https://github.com/keithamus/sort-package-json#readme)

CLIä½¿ç”¨ï¼š

```bash
$ sort-package-json "my-package/package.json" "other-package/package.json"

$ sort-package-json "package.json" "packages/*/package.json"
```

## husky

> [typicode/husky: Git hooks made easy ğŸ¶ woof!  (github.com)](https://github.com/typicode/husky)

`husky` çš„ä¸»è¦ä½œç”¨æ˜¯å¸®åŠ©å¼€å‘è€…åœ¨ Git æ“ä½œæ—¶è‡ªåŠ¨åŒ–æ‰§è¡Œä¸€äº›ä»»åŠ¡ï¼Œæé«˜å¼€å‘æ•ˆç‡å’Œä»£ç è´¨é‡ã€‚ä¾‹å¦‚ï¼Œåœ¨æäº¤ä»£ç æ—¶è‡ªåŠ¨è¿è¡Œä»£ç æ ¼å¼åŒ–å·¥å…·ï¼Œç¡®ä¿ä»£ç é£æ ¼ä¸€è‡´ï¼›åœ¨æ¨é€ä»£ç æ—¶è‡ªåŠ¨è¿è¡Œå•å…ƒæµ‹è¯•ï¼Œç¡®ä¿ä»£ç è´¨é‡ç¬¦åˆè¦æ±‚ã€‚

### Install å®‰è£…

```
npm install husky -D
```

### Usage ç”¨æ³•

- ç¼–è¾‘ `package.json > prepare` è„šæœ¬å¹¶è¿è¡Œä¸€æ¬¡ï¼š

  ```bash
  npm pkg set scripts.prepare="husky install"
  npm run prepare
  ```

- æ·»åŠ é’©å­ï¼š

  ```
  npx husky add .husky/pre-commit "pnpm lint-staged"
  git add .husky/pre-commit
  ```

- æäº¤:

  ```bash
  git commit -m "Keep calm and commit"
  # `npm test` will run every time you commit
  ```

  

### æ–‡æ¡£

https://typicode.github.io/husky

## å¦‚ä½•æŠŠä¸Šé¢è¿™äº›å·¥å…·éƒ½ä¸²è”èµ·æ¥ä½¿ç”¨ï¼Ÿ

- huskyå’Œlint-stagedæ˜¯é…åˆä½¿ç”¨çš„
- lint-stagedå’Œå…¶ä»–åŒ…æ˜¯é…åˆä½¿ç”¨çš„

æ‰€ä»¥å…ˆé…å¥½husky

### 1. é…ç½®husky

åœ¨package.jsoné…ç½®å‘½ä»¤ï¼š

```json
{
  "scripts": {
    "prepare": "husky install",
  }
}
```

åœ¨è¿è¡Œ`pnpm prepare`åï¼Œæ ¹ç›®å½•ä¸‹ä¼šç”Ÿæˆä¸€ä¸ª`.husky`ç›®å½•ï¼Œç„¶åä½¿ç”¨ä¸€ä¸‹å‘½ä»¤ç”Ÿæˆé’©å­è„šæ­¥æ–‡ä»¶ï¼š

```bash
npx husky add .husky/pre-commit "pnpm lint-staged"
```

ç”Ÿæˆçš„`pre-commit`æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```sh
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

pnpm lint-stage
```

### 2. é…ç½®lint-staged

ä¸Šé¢çš„è„šæœ¬ä¸­é…ç½®äº†`pnpm lint-stage`ï¼Œè„šæœ¬è¿è¡Œæ—¶ä¼šè‡ªåŠ¨è¿è¡Œè¿™æ¡å‘½ä»¤ä¸ä¼šæŠ¥é”™ï¼Œå³ä½¿ä½ çš„`package.json`æ²¡æœ‰é…ç½®è¿™æ¡å‘½ä»¤ï¼Œä¸è¿‡ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œè¿˜æ˜¯åœ¨scriptä¸­åŠ ä¸Šè¿™æ¡é…ç½®:

```json
//package.json
{
"scripts": {
    "lint-staged": "lint-staged --allow-empty",//é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“Linterä»»åŠ¡æ’¤æ¶ˆæ‰€æœ‰æš‚å­˜çš„æ›´æ”¹æ—¶ï¼Œlint-stageå°†é€€å‡ºå¹¶è¿”å›é”™è¯¯å¹¶ä¸­æ­¢æäº¤ã€‚ä½¿ç”¨æ­¤æ ‡å¿—å¯å…è®¸åˆ›å»ºç©ºçš„GITæäº¤ã€‚
  },
}
```

ç„¶åé…ç½®lint-stagedçš„å…·ä½“é…ç½®ï¼š

**å±æ€§**ä»£è¡¨åŒ¹é…çš„æ–‡ä»¶åï¼Œ**å€¼**å¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–è€…æ˜¯æ•°ç»„ï¼Œæ¯ä¸€æ¡ä»£è¡¨ä¸€ä¸ªå‘½ä»¤ï¼Œå¯ä»¥ä½¿ç”¨prettierå’Œeslintå‘½ä»¤ï¼Œæˆ‘è¿™ä½¿ç”¨romeä»£æ›¿ã€‚

```json
//package.json
{
    "lint-staged": {
        "*.{ts,tsx,js,cjs}": [
          "rome format --write",
          "rome check"
        ],
        "*.{md,html,css,json,yml}": "prettier --write",
        "!(*pnpm-lock).yaml": "prettier --write",
        "package.json": "pnpm sort-package-json"
      },
}
```

```json
{
      "lint-staged": {
        "*.{css,md,json}": [
          "prettier --write"
        ],
        "*.ts?(x)": [
          "eslint",
          "prettier --write"
        ],
        "package.json": "npx sort-package-json"
      },
}
```



## å‚è€ƒæ–‡ç« 

> [å‰ç«¯é¡¹ç›® Git æäº¤çº¦æŸé…ç½® - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/425546983)